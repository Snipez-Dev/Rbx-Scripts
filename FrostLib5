-- VanUI (komplett, gefixt)
-- Fixes:
--  • Restore-Box wird jetzt zuverlässig erstellt (wird ins PlayerGui parented)
--  • Restore-Box ist verschiebbar und Klick darauf stellt UI wieder her
--  • Robustere Drag-/Click-Erkennung für die Box
--  • Keine weiteren unnötigen Änderungen an API/Features

local Library = {}
Library.Windows = {}
Library.MainWindow = nil

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local TextService = game:GetService("TextService")
local RunService = game:GetService("RunService")

local function New(ClassName, Properties)
	local Object = Instance.new(ClassName)
	if Properties then
		for Property, Value in next, Properties do
			pcall(function() Object[Property] = Value end)
		end
	end
	return Object
end

local DEFAULT_THEME = {
	Background = Color3.fromRGB(7,7,7),
	Panel = Color3.fromRGB(20,20,20),
	PanelStroke = Color3.fromRGB(25,25,25),
	Tab = Color3.fromRGB(15,15,15),
	TabStroke = Color3.fromRGB(116,116,116),
	ToggleBg = Color3.fromRGB(38,38,38),
	ToggleOn = Color3.fromRGB(230,230,230),
	ToggleOff = Color3.fromRGB(30,30,30),
	Fill = Color3.fromRGB(200,200,200),
	ControlBtnText = Color3.fromRGB(150,150,150)
}

local function themeGet(theme, key)
	if theme and type(theme) == "table" and theme[key] ~= nil then return theme[key] end
	return DEFAULT_THEME[key]
end

local function getViewport()
	if workspace and workspace.CurrentCamera then
		return workspace.CurrentCamera.ViewportSize
	end
	return Vector2.new(1920,1080)
end

-- CreateWindow(title, subtitle, opts)
-- opts: size (UDim2) or width/height numbers, theme (table), force (boolean)
function Library:CreateWindow(title, subtitle, opts)
	opts = opts or {}
	local theme = opts.theme or nil

	-- single instance unless forced
	if Library.MainWindow and not opts.force then
		return Library.MainWindow
	end

	-- optional force destroy
	if opts.force and Library.MainWindow then
		pcall(function() Library.MainWindow:Destroy() end)
	end

	-- size handling
	local defaultW, defaultH = 760, 420
	local sizeUDim
	if opts.size and typeof(opts.size) == "UDim2" then
		sizeUDim = opts.size
	elseif opts.width and opts.height then
		sizeUDim = UDim2.new(0, opts.width, 0, opts.height)
	else
		sizeUDim = UDim2.new(0, defaultW, 0, defaultH)
	end
	local absW = sizeUDim.X.Offset
	local absH = sizeUDim.Y.Offset

	-- ScreenGui parented to PlayerGui to ensure visibility (fixes missing restore box)
	local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
	local ScreenGui = New("ScreenGui", { Name = "VanUI", ZIndexBehavior = Enum.ZIndexBehavior.Sibling, ResetOnSpawn = false })
	ScreenGui.Parent = playerGui

	-- Background
	local Background = New("Frame", {
		Name = "Background",
		Parent = ScreenGui,
		AnchorPoint = Vector2.new(0.5,0.5),
		BackgroundColor3 = themeGet(theme, "Background"),
		BorderSizePixel = 0,
		ClipsDescendants = true,
		Position = UDim2.new(0.5, 0, 0.45, 0),
		Size = UDim2.new(0, 0, 0, 0),
		BackgroundTransparency = 1
	})
	New("UICorner", {CornerRadius = UDim.new(0.02,0), Parent = Background})
	local BackgroundStroke = New("UIStroke", {Color = themeGet(theme, "PanelStroke"), Thickness = 1, Transparency = 1, Parent = Background})

	-- open tween
	TweenService:Create(Background, TweenInfo.new(0.45, Enum.EasingStyle.Back, Enum.EasingDirection.Out), { Size = sizeUDim, BackgroundTransparency = 0 }):Play()
	task.wait(0.22)
	TweenService:Create(BackgroundStroke, TweenInfo.new(0.22), { Transparency = 0 }):Play()

	-- TopBar / Header
	local HeaderHeight = 60
	local TopBar = New("Frame", { Name = "TopBar", Parent = Background, BackgroundTransparency = 1, Position = UDim2.new(0,0,0,0), Size = UDim2.new(1,0,0,HeaderHeight) })
	local TitleLabel = New("TextLabel", { Name = "title", Parent = TopBar, BackgroundTransparency = 1, Position = UDim2.new(0.03,0,0.18,0), Size = UDim2.new(0.5,0,0,28), Font = Enum.Font.GothamMedium, Text = title or "VanUI", TextColor3 = Color3.fromRGB(255,255,255), TextSize = 16, TextXAlignment = Enum.TextXAlignment.Left, TextYAlignment = Enum.TextYAlignment.Center })
	New("TextLabel", { Name = "subtitle", Parent = TopBar, BackgroundTransparency = 1, Position = UDim2.new(0.03,0,0.55,0), Size = UDim2.new(0.5,0,0,14), Font = Enum.Font.Gotham, Text = subtitle or "", TextColor3 = Color3.fromRGB(150,150,150), TextSize = 12, TextXAlignment = Enum.TextXAlignment.Left })

	-- Controls (small & lower)
	local ControlsFrame = New("Frame", { Name = "WindowControls", Parent = TopBar, BackgroundTransparency = 1, Size = UDim2.new(0,74,0,28), Position = UDim2.new(1,-10,0,8), AnchorPoint = Vector2.new(1,0) })
	New("UIListLayout", { Parent = ControlsFrame, FillDirection = Enum.FillDirection.Horizontal, HorizontalAlignment = Enum.HorizontalAlignment.Right, VerticalAlignment = Enum.VerticalAlignment.Center, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0,6) })

	local function makeControl(symbol)
		local btn = New("TextButton", { Parent = ControlsFrame, BackgroundColor3 = Background.BackgroundColor3, BorderSizePixel = 0, Size = UDim2.new(0,28,0,20), AutoButtonColor = false, Font = Enum.Font.SourceSansBold, Text = symbol, TextColor3 = themeGet(theme, "ControlBtnText"), TextSize = 18, TextScaled = true })
		New("UICorner", {Parent = btn, CornerRadius = UDim.new(0.08,0)})
		New("UIStroke", {Parent = btn, Color = themeGet(theme, "PanelStroke"), Thickness = 1})
		return btn
	end
	local MinBtn = makeControl("▭")
	local CloseBtn = makeControl("✕")

	-- Layout values
	local TabWidth = 170
	local TabLeftPadding = 12
	local ContentLeft = TabLeftPadding + TabWidth + 12
	local ContentWidth = math.max(220, absW - ContentLeft - 12)
	local ContentHeight = math.max(120, absH - HeaderHeight - 20)

	local TabContainer = New("Frame", { Name = "TabContainer", Parent = Background, BackgroundTransparency = 1, Position = UDim2.new(0, TabLeftPadding, 0, HeaderHeight), Size = UDim2.new(0, TabWidth, 0, ContentHeight) })
	New("UIListLayout", {Parent = TabContainer, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0,8)})

	local ContentContainer = New("ScrollingFrame", { Name = "ContentContainer", Parent = Background, BackgroundTransparency = 1, BorderSizePixel = 0, Position = UDim2.new(0, ContentLeft, 0, HeaderHeight - 2), Size = UDim2.new(0, ContentWidth, 0, ContentHeight + 2), CanvasSize = UDim2.new(0,0,0,0), ScrollBarThickness = 6 })
	New("UIPadding", {Parent = ContentContainer, PaddingLeft = UDim.new(0,10), PaddingRight = UDim.new(0,10), PaddingTop = UDim.new(0,10)})
	local contentLayout = New("UIListLayout", {Parent = ContentContainer, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0,8)})
	contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
		ContentContainer.CanvasSize = UDim2.new(0,0,0, contentLayout.AbsoluteContentSize.Y + 20)
	end)

	local ContentBackground = New("Frame", { Parent = Background, BackgroundColor3 = themeGet(theme, "Panel"), BackgroundTransparency = 0.3, BorderSizePixel = 0, Position = UDim2.new(0, ContentLeft, 0, HeaderHeight), Size = UDim2.new(0, ContentWidth, 0, ContentHeight) })
	New("UICorner", {Parent = ContentBackground, CornerRadius = UDim.new(0.01,0)})
	New("UIStroke", {Parent = ContentBackground, Color = themeGet(theme, "PanelStroke"), Thickness = 1})

	-- Window object
	local Window = {}
	Window.Tabs = {}
	Window.CurrentTab = nil
	Window._isMinimized = false
	Window._ScreenGui = ScreenGui
	Window._restoreGui = nil

	-- Drag main window: only when clicking in TopBar left half
	local dragging, dragInput, dragStart, startPos, dragTween
	TopBar.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			local bgPos = Background.AbsolutePosition
			local bgSize = Background.AbsoluteSize
			local clickX = input.Position.X
			if clickX <= bgPos.X + (bgSize.X * 0.5) then
				dragging = true
				dragStart = input.Position
				startPos = Background.Position
				if dragTween then dragTween:Cancel() end
				input.Changed:Connect(function()
					if input.UserInputState == Enum.UserInputState.End then dragging = false end
				end)
			end
		end
	end)
	TopBar.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
	end)
	UserInputService.InputChanged:Connect(function(input)
		if input == dragInput and dragging then
			local delta = input.Position - dragStart
			local newPosition = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
			if dragTween then dragTween:Cancel() end
			dragTween = TweenService:Create(Background, TweenInfo.new(0.09, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), { Position = newPosition })
			dragTween:Play()
		end
	end)

	-- Close button
	CloseBtn.MouseButton1Click:Connect(function()
		if Window._ScreenGui then pcall(function() Window._ScreenGui:Destroy() end) end
		if Window._restoreGui then pcall(function() Window._restoreGui:Destroy() end) end
		for i, w in pairs(Library.Windows) do if w == Window then table.remove(Library.Windows, i); break end end
		if Library.MainWindow == Window then Library.MainWindow = nil end
	end)

	-- Minimize -> create movable restore box; click restore
	MinBtn.MouseButton1Click:Connect(function()
		if Window._isMinimized then
			-- restore
			if Window._restoreGui then pcall(function() Window._restoreGui:Destroy() end) end
			Window._restoreGui = nil
			Background.Visible = true
			Window._isMinimized = false
		else
			-- minimize
			Background.Visible = false
			Window._isMinimized = true

			-- ensure any previous restore GUI is cleaned up
			if Window._restoreGui then
				pcall(function() Window._restoreGui:Destroy() end)
				Window._restoreGui = nil
			end

			-- Create RestoreGui parented to PlayerGui to ensure visibility
			local RestoreGui = New("ScreenGui", { Name = "VanUI_Restore", ZIndexBehavior = Enum.ZIndexBehavior.Sibling, ResetOnSpawn = false })
			RestoreGui.Parent = playerGui

			-- default placement bottom-right
			local vp = getViewport()
			local boxW, boxH = 180, 40
			local margin = 18
			local initialX = math.max(8, vp.X - boxW - margin)
			local initialY = math.max(8, vp.Y - boxH - margin)

			local Box = New("Frame", { Name = "RestoreBox", Parent = RestoreGui, AnchorPoint = Vector2.new(0,0), Size = UDim2.new(0, boxW, 0, boxH), Position = UDim2.new(0, initialX, 0, initialY), BackgroundColor3 = themeGet(theme, "Panel"), BorderSizePixel = 0 })
			New("UICorner", { Parent = Box, CornerRadius = UDim.new(0.08,0) })
			New("UIStroke", { Parent = Box, Color = themeGet(theme, "PanelStroke"), Thickness = 1 })

			local Label = New("TextLabel", { Parent = Box, BackgroundTransparency = 1, Size = UDim2.new(1, -46, 1, 0), Position = UDim2.new(0, 12, 0, 0), Font = Enum.Font.Gotham, Text = title or "VanUI", TextColor3 = Color3.fromRGB(255,255,255), TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left, TextYAlignment = Enum.TextYAlignment.Center })

			-- Restore icon
			local RestoreIcon = New("TextLabel", { Parent = Box, Size = UDim2.new(0, 34, 0, 34), Position = UDim2.new(1, -40, 0.5, -17), BackgroundColor3 = Background.BackgroundColor3, BorderSizePixel = 0, Text = "▣", Font = Enum.Font.SourceSansBold, TextColor3 = themeGet(theme, "ControlBtnText"), TextSize = 18, TextScaled = true })
			New("UICorner", { Parent = RestoreIcon, CornerRadius = UDim.new(0.08,0) })
			New("UIStroke", { Parent = RestoreIcon, Color = themeGet(theme, "PanelStroke"), Thickness = 1 })

			-- Overlay used for dragging and click detection
			local Overlay = New("TextButton", { Parent = Box, BackgroundTransparency = 1, Size = UDim2.new(1, -46, 1, 0), Position = UDim2.new(0, 0, 0, 0), Text = "", AutoButtonColor = false })
			-- ensure AbsoluteSize ready
			RunService.Heartbeat:Wait()

			-- dragging logic for Box with click detection
			local draggingBox = false
			local dragStartPos = nil
			local boxStartPos = nil
			local currentInput = nil

			Overlay.InputBegan:Connect(function(inp)
				if inp.UserInputType == Enum.UserInputType.MouseButton1 then
					draggingBox = true
					dragStartPos = inp.Position
					boxStartPos = Vector2.new(Box.Position.X.Offset, Box.Position.Y.Offset)
					currentInput = inp
					inp.Changed:Connect(function()
						if inp.UserInputState == Enum.UserInputState.End then
							-- on mouse release decide if it was a click (small movement) or drag
							draggingBox = false
							local releasePos = inp.Position
							local delta = releasePos - dragStartPos
							if math.abs(delta.X) < 6 and math.abs(delta.Y) < 6 then
								-- treat as click -> restore UI
								if Window._restoreGui then pcall(function() Window._restoreGui:Destroy() end) end
								Window._restoreGui = nil
								Background.Visible = true
								Window._isMinimized = false
							end
							currentInput = nil
						end
					end)
				end
			end)

			UserInputService.InputChanged:Connect(function(inp)
				if draggingBox and inp.UserInputType == Enum.UserInputType.MouseMovement and inp == currentInput and dragStartPos and boxStartPos then
					local delta = inp.Position - dragStartPos
					local newX = boxStartPos.X + delta.X
					local newY = boxStartPos.Y + delta.Y
					local vp2 = getViewport()
					newX = math.clamp(newX, 0, vp2.X - Box.AbsoluteSize.X)
					newY = math.clamp(newY, 0, vp2.Y - Box.AbsoluteSize.Y)
					Box.Position = UDim2.new(0, newX, 0, newY)
				end
			end)

			-- RestoreIcon click also restores
			RestoreIcon.InputBegan:Connect(function(inp)
				if inp.UserInputType == Enum.UserInputType.MouseButton1 then
					if Window._restoreGui then pcall(function() Window._restoreGui:Destroy() end) end
					Window._restoreGui = nil
					Background.Visible = true
					Window._isMinimized = false
				end
			end)

			Window._restoreGui = RestoreGui
		end
	end)

	-- Tab API
	function Window:CreateTab(name)
		local Tab = {}
		local isFirst = #Window.Tabs == 0

		local TabButton = New("TextButton", {
			Name = "Tab_" .. name,
			Parent = TabContainer,
			BackgroundColor3 = themeGet(theme, "Tab"),
			BackgroundTransparency = isFirst and 0 or 1,
			BorderSizePixel = 0,
			Size = UDim2.new(1,0,0,35),
			Font = Enum.Font.Gotham,
			Text = name,
			TextColor3 = isFirst and Color3.fromRGB(255,255,255) or Color3.fromRGB(150,150,150),
			TextSize = 14,
			TextXAlignment = Enum.TextXAlignment.Left,
			AutoButtonColor = false
		})
		New("UIPadding", {Parent = TabButton, PaddingLeft = UDim.new(0,5)})
		New("UICorner", {Parent = TabButton, CornerRadius = UDim.new(0.1,0)})
		New("UIStroke", {Parent = TabButton, Color = themeGet(theme, "TabStroke"), Thickness = 1, Transparency = isFirst and 0.8 or 1, ApplyStrokeMode = Enum.ApplyStrokeMode.Border})

		TabButton.MouseButton1Click:Connect(function()
			if Window.CurrentTab == Tab then return end
			for _, t in pairs(Window.Tabs) do
				TweenService:Create(t.Button, TweenInfo.new(0.18), { BackgroundTransparency = 1, TextColor3 = Color3.fromRGB(150,150,150) }):Play()
				local stroke = t.Button:FindFirstChildOfClass("UIStroke")
				if stroke then TweenService:Create(stroke, TweenInfo.new(0.18), {Transparency = 1}):Play() end
			end
			TweenService:Create(TabButton, TweenInfo.new(0.18), { BackgroundTransparency = 0, TextColor3 = Color3.fromRGB(255,255,255) }):Play()
			local stroke = TabButton:FindFirstChildOfClass("UIStroke")
			if stroke then TweenService:Create(stroke, TweenInfo.new(0.18), {Transparency = 0.8}):Play() end
			Window.CurrentTab = Tab
			Window:RefreshContent()
		end)

		Tab.Button = TabButton
		Tab.Elements = {}
		table.insert(Window.Tabs, Tab)
		if isFirst then Window.CurrentTab = Tab end

		function Tab:AddParagraph(titleText, contentText)
			local Paragraph = { Type = "Paragraph", Title = titleText, Content = contentText, Visible = true }
			table.insert(Tab.Elements, Paragraph); Window:RefreshContent()
			return {
				Hide = function() Paragraph.Visible = false; Window:RefreshContent() end,
				Show = function() Paragraph.Visible = true; Window:RefreshContent() end
			}
		end

		function Tab:AddButton(text, callback)
			local Button = { Type = "Button", Text = text, Callback = callback, Visible = true }
			table.insert(Tab.Elements, Button); Window:RefreshContent()
			return {
				Hide = function() Button.Visible = false; Window:RefreshContent() end,
				Show = function() Button.Visible = true; Window:RefreshContent() end
			}
		end

		function Tab:AddToggle(text, default, callback)
			local Toggle = { Type = "Toggle", Text = text, Value = default or false, Callback = callback, Visible = true }
			table.insert(Tab.Elements, Toggle); Window:RefreshContent()
			return {
				Set = function(self, value) Toggle.Value = value; Window:RefreshContent() end,
				Hide = function() Toggle.Visible = false; Window:RefreshContent() end,
				Show = function() Toggle.Visible = true; Window:RefreshContent() end
			}
		end

		function Tab:AddSlider(text, min, max, default, callback)
			min = min or 0; max = max or 100; default = default == nil and min or default
			local Slider = { Type = "Slider", Text = text, Min = min, Max = max, Value = math.clamp(default, min, max), Callback = callback, Visible = true }
			table.insert(Tab.Elements, Slider); Window:RefreshContent()
			return {
				Set = function(self, value) Slider.Value = math.clamp(value, Slider.Min, Slider.Max); Window:RefreshContent(); if Slider.Callback then pcall(Slider.Callback, Slider.Value) end end,
				Hide = function() Slider.Visible = false; Window:RefreshContent() end,
				Show = function() Slider.Visible = true; Window:RefreshContent() end
			}
		end

		return Tab
	end

	-- Refresh content
	function Window:RefreshContent()
		for _, child in pairs(ContentContainer:GetChildren()) do
			if child:IsA("Frame") then child:Destroy() end
		end
		if not Window.CurrentTab then return end

		for _, element in pairs(Window.CurrentTab.Elements) do
			if not element.Visible then continue end

			if element.Type == "Paragraph" then
				local P = New("Frame", {Parent = ContentContainer, BackgroundColor3 = themeGet(theme, "Panel"), BorderSizePixel = 0, Size = UDim2.new(1,0,0,100)})
				New("UICorner", {Parent = P, CornerRadius = UDim.new(0.05,0)})
				New("UIStroke", {Parent = P, Color = themeGet(theme, "PanelStroke"), Thickness = 1})
				New("UIPadding", {Parent = P, PaddingLeft = UDim.new(0,12), PaddingRight = UDim.new(0,12), PaddingTop = UDim.new(0,12), PaddingBottom = UDim.new(0,12)})
				New("TextLabel", {Parent = P, BackgroundTransparency = 1, Size = UDim2.new(1,0,0,20), Font = Enum.Font.GothamMedium, Text = element.Title or "", TextColor3 = Color3.fromRGB(255,255,255), TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left})
				New("TextLabel", {Parent = P, BackgroundTransparency = 1, Position = UDim2.new(0,0,0,22), Size = UDim2.new(1,0,1,-22), Font = Enum.Font.Gotham, Text = element.Content or "", TextColor3 = Color3.fromRGB(150,150,150), TextSize = 13, TextWrapped = true})
				task.spawn(function()
					task.wait()
					local titleSize = TextService:GetTextSize(element.Title or "", 14, Enum.Font.GothamMedium, Vector2.new(P.AbsoluteSize.X - 24, math.huge))
					local contentSize = TextService:GetTextSize(element.Content or "", 13, Enum.Font.Gotham, Vector2.new(P.AbsoluteSize.X - 24, math.huge))
					P.Size = UDim2.new(1,0,0, titleSize.Y + contentSize.Y + 32)
				end)

			elseif element.Type == "Button" then
				local F = New("Frame", {Parent = ContentContainer, BackgroundColor3 = themeGet(theme, "Panel"), BorderSizePixel = 0, Size = UDim2.new(1,0,0,42)})
				New("UICorner", {Parent = F, CornerRadius = UDim.new(0.1,0)})
				New("UIStroke", {Parent = F, Color = themeGet(theme, "PanelStroke"), Thickness = 1})
				New("TextLabel", {Parent = F, BackgroundTransparency = 1, Position = UDim2.new(0.03,0,0,0), Size = UDim2.new(0.94,0,1,0), Font = Enum.Font.GothamMedium, Text = element.Text or "", TextColor3 = Color3.fromRGB(255,255,255), TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left})
				local Click = New("TextButton", {Parent = F, BackgroundTransparency = 1, Size = UDim2.new(1,0,1,0), Text = "", AutoButtonColor = false})
				Click.MouseButton1Click:Connect(function()
					TweenService:Create(F, TweenInfo.new(0.09), {BackgroundColor3 = Color3.fromRGB(30,30,30)}):Play()
					task.wait(0.09)
					TweenService:Create(F, TweenInfo.new(0.09), {BackgroundColor3 = themeGet(theme, "Panel")}):Play()
					if element.Callback then pcall(element.Callback) end
				end)

			elseif element.Type == "Toggle" then
				local F = New("Frame", {Parent = ContentContainer, BackgroundColor3 = themeGet(theme, "Panel"), BorderSizePixel = 0, Size = UDim2.new(1,0,0,42)})
				New("UICorner", {Parent = F, CornerRadius = UDim.new(0.1,0)})
				New("UIStroke", {Parent = F, Color = themeGet(theme, "PanelStroke"), Thickness = 1})
				New("TextLabel", {Parent = F, BackgroundTransparency = 1, Position = UDim2.new(0.03,0,0,0), Size = UDim2.new(0.75,0,1,0), Font = Enum.Font.GothamMedium, Text = element.Text or "", TextColor3 = Color3.fromRGB(255,255,255), TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left})

				local IndicatorBg = New("Frame", { Parent = F, AnchorPoint = Vector2.new(1,0.5), Position = UDim2.new(0.975,0,0.5,0), Size = UDim2.new(0,24,0,24), BackgroundColor3 = themeGet(theme, "ToggleBg"), BorderSizePixel = 0 })
				New("UICorner", {Parent = IndicatorBg, CornerRadius = UDim.new(0.5,0)})
				New("UIStroke", {Parent = IndicatorBg, Color = themeGet(theme, "PanelStroke"), Thickness = 1})

				local Indicator = New("Frame", { Parent = IndicatorBg, AnchorPoint = Vector2.new(0.5,0.5), Position = UDim2.new(0.5,0,0.5,0), Size = UDim2.new(0,16,0,16), BackgroundColor3 = element.Value and themeGet(theme, "ToggleOn") or themeGet(theme, "ToggleOff"), BorderSizePixel = 0 })
				New("UICorner", {Parent = Indicator, CornerRadius = UDim.new(0.5,0)})
				New("UIStroke", {Parent = Indicator, Color = themeGet(theme, "PanelStroke"), Thickness = 1})

				local Click = New("TextButton", {Parent = F, BackgroundTransparency = 1, Size = UDim2.new(1,0,1,0), Text = "", AutoButtonColor = false})
				Click.MouseButton1Click:Connect(function()
					element.Value = not element.Value
					TweenService:Create(Indicator, TweenInfo.new(0.18), { BackgroundColor3 = element.Value and themeGet(theme, "ToggleOn") or themeGet(theme, "ToggleOff") }):Play()
					if element.Callback then pcall(element.Callback, element.Value) end
				end)

			elseif element.Type == "Slider" then
				local F = New("Frame", {Parent = ContentContainer, BackgroundColor3 = themeGet(theme, "Panel"), BorderSizePixel = 0, Size = UDim2.new(1,0,0,56)})
				New("UICorner", {Parent = F, CornerRadius = UDim.new(0.06,0)})
				New("UIStroke", {Parent = F, Color = themeGet(theme, "PanelStroke"), Thickness = 1})
				New("UIPadding", {Parent = F, PaddingLeft = UDim.new(0,12), PaddingRight = UDim.new(0,12), PaddingTop = UDim.new(0,8), PaddingBottom = UDim.new(0,8)})

				local Label = New("TextLabel", {Parent = F, BackgroundTransparency = 1, Position = UDim2.new(0,0,0,0), Size = UDim2.new(0.55,0,0.55,0), Font = Enum.Font.GothamMedium, Text = element.Text or "Slider", TextColor3 = Color3.fromRGB(255,255,255), TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left})
				local ValueLabel = New("TextLabel", {Parent = F, BackgroundTransparency = 1, Position = UDim2.new(0.55,0,0,0), Size = UDim2.new(0.45,0,0.55,0), Font = Enum.Font.Gotham, Text = tostring(math.floor(element.Value*100)/100), TextColor3 = Color3.fromRGB(150,150,150), TextSize = 13, TextXAlignment = Enum.TextXAlignment.Right})

				local TrackContainer = New("Frame", {Parent = F, BackgroundTransparency = 1, Size = UDim2.new(1,0,0,18), Position = UDim2.new(0,0,1,-18)})
				local Track = New("Frame", {Parent = TrackContainer, BackgroundColor3 = Color3.fromRGB(35,35,35), Size = UDim2.new(1,0,1,0), BorderSizePixel = 0})
				New("UICorner", {Parent = Track, CornerRadius = UDim.new(0.5,0)})
				New("UIStroke", {Parent = Track, Color = themeGet(theme, "PanelStroke"), Thickness = 1})

				local Fill = New("Frame", {Parent = Track, BackgroundColor3 = themeGet(theme, "Fill"), Size = UDim2.new(0,0,1,0), BorderSizePixel = 0})
				New("UICorner", {Parent = Fill, CornerRadius = UDim.new(0.5,0)})

				local Knob = New("Frame", {Parent = Track, BackgroundColor3 = themeGet(theme, "ToggleOn"), Size = UDim2.new(0,18,0,18), AnchorPoint = Vector2.new(0,0.5), Position = UDim2.new(0,0,0.5,0), BorderSizePixel = 0})
				New("UICorner", {Parent = Knob, CornerRadius = UDim.new(0.5,0)})
				New("UIStroke", {Parent = Knob, Color = themeGet(theme, "PanelStroke"), Thickness = 1})

				local function updateVisuals(val)
					local pct = 0
					if element.Max ~= element.Min then pct = (val - element.Min) / (element.Max - element.Min) end
					pct = math.clamp(pct, 0, 1)
					Fill.Size = UDim2.new(pct,0,1,0)
					Knob.Position = UDim2.new(math.clamp(pct,0,1), -9, 0.5, 0)
					ValueLabel.Text = tostring(math.floor(val * 100) / 100)
				end
				updateVisuals(element.Value)

				-- slider dragging (local)
				do
					local draggingSlider = false
					local function setValueFromPos(x)
						local absX = x - Track.AbsolutePosition.X
						local width = Track.AbsoluteSize.X
						local pct = math.clamp(absX / math.max(width,1), 0, 1)
						local newVal = element.Min + (element.Max - element.Min) * pct
						element.Value = newVal
						updateVisuals(element.Value)
						if element.Callback then pcall(element.Callback, element.Value) end
					end

					Track.InputBegan:Connect(function(inp)
						if inp.UserInputType == Enum.UserInputType.MouseButton1 then
							draggingSlider = true
							setValueFromPos(inp.Position.X)
						end
					end)
					Track.InputEnded:Connect(function(inp)
						if inp.UserInputType == Enum.UserInputType.MouseButton1 then draggingSlider = false end
					end)
					Knob.InputBegan:Connect(function(inp)
						if inp.UserInputType == Enum.UserInputType.MouseButton1 then draggingSlider = true end
					end)
					Knob.InputEnded:Connect(function(inp)
						if inp.UserInputType == Enum.UserInputType.MouseButton1 then draggingSlider = false end
					end)
					UserInputService.InputChanged:Connect(function(inp)
						if inp.UserInputType == Enum.UserInputType.MouseMovement and draggingSlider then
							setValueFromPos(inp.Position.X)
						end
					end)
				end
			end
		end
	end

	-- Destroy method
	function Window:Destroy()
		if Window._ScreenGui then pcall(function() Window._ScreenGui:Destroy() end) end
		if Window._restoreGui then pcall(function() Window._restoreGui:Destroy() end) end
		for i, w in pairs(Library.Windows) do
			if w == Window then table.remove(Library.Windows, i); break end
		end
		if Library.MainWindow == Window then Library.MainWindow = nil end
	end

	table.insert(Library.Windows, Window)
	Library.MainWindow = Window
	return Window
end

return Library
