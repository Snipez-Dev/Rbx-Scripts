-- VanithUI_Exact_v7f.luau
-- Changes vs v7e:
--  • Dropbox reworked: proper "< / v" toggle, capped height, inner scroll, outside-click to close, high ZIndex, strict dark theme
--  • Dropdown gets same capped-height + inner scroll + high ZIndex
--  • Removed button "glow"/flash everywhere (no AutoButtonColor effects)
--  • Kept all prior APIs intact (CreateWindow, CreateTab, SetChangelog, SetDiscordURL, Notify, Dropdown, Dropbox, etc.)

local VanithUI = {}

-- Services
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Stats = game:GetService("Stats")

-- Theme / Layout
local DEFAULT_HUE = 0.58
local BASE_W, BASE_H = 650, 300
local TOP_H          = 28
local START_POS      = UDim2.new(0.15,0,0.2,20)
local MAX_TABS       = 7 -- incl. Main

local COLOR_BG      = Color3.fromRGB(18,18,18)
local COLOR_PANEL   = Color3.fromRGB(25,25,25)
local COLOR_SIDEBAR = Color3.fromRGB(15,15,15)
local COLOR_TEXT    = Color3.fromRGB(220,220,220)
local COLOR_POPUP = Color3.fromRGB(14,14,14)

local INNER_PAD = 14
local CTL_HPAD  = 12
local CTL_GAP   = 8

-- Utils
local function round(o, r)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, r or 6)
    c.Parent = o
    return c
end

local function getRoot()
    local ok, ui = pcall(function()
        local f = gethui and gethui()
        if typeof(f) == "Instance" then return f end
        return CoreGui
    end)
    return ok and ui or CoreGui
end

local function getPingMs()
    local ok, val = pcall(function()
        local item = Stats.Network.ServerStatsItem["Data Ping"]
        if not item then return nil end
        local s = item:GetValueString()
        return tonumber(string.match(s or "", "(%d+)"))
    end)
    if ok then return val end
    return nil
end

-- ================== Notify (stacking) ==================
local function createNotifier(root, accent)
    local holder = root:FindFirstChild("Vanith_Notify")
    if not holder then
        holder = Instance.new("Frame")
        holder.Name = "Vanith_Notify"
        holder.BackgroundTransparency = 1
        holder.Size = UDim2.new(0, 300, 1, 0)
        holder.Position = UDim2.new(1, -320, 0, 20)
        holder.ZIndex = 50
        holder.Parent = root

        local layout = Instance.new("UIListLayout")
        layout.SortOrder = Enum.SortOrder.LayoutOrder
        layout.Padding = UDim.new(0, 8)
        layout.Parent = holder
    end

    local function notify(title, message, duration)
        local card = Instance.new("Frame")
        card.Size = UDim2.new(1,0,0,80)
        card.BackgroundColor3 = COLOR_PANEL
        card.BorderSizePixel = 0
        card.ZIndex = 51
        round(card, 8)
        card.Parent = holder

        local bar = Instance.new("Frame")
        bar.Size = UDim2.new(0,4,1,0)
        bar.BackgroundColor3 = accent
        bar.BorderSizePixel = 0
        bar.ZIndex = 52
        round(bar,8)
        bar.Parent = card

        local t = Instance.new("TextLabel")
        t.BackgroundTransparency = 1
        t.Font = Enum.Font.GothamBold
        t.TextSize = 16
        t.TextXAlignment = Enum.TextXAlignment.Left
        t.TextColor3 = accent
        t.Text = title or ""
        t.Size = UDim2.new(1,-32,0,20)
        t.Position = UDim2.new(0,16,0,8)
        t.ZIndex = 52
        t.Parent = card

        local m = Instance.new("TextLabel")
        m.BackgroundTransparency = 1
        m.Font = Enum.Font.Gotham
        m.TextSize = 14
        m.TextXAlignment = Enum.TextXAlignment.Left
        m.TextYAlignment = Enum.TextYAlignment.Top
        m.TextWrapped = true
        m.TextColor3 = COLOR_TEXT
        m.Text = message or ""
        m.Size = UDim2.new(1,-32,0,40)
        m.Position = UDim2.new(0,16,0,32)
        m.ZIndex = 52
        m.Parent = card

        task.delay(duration or 2, function()
            local tween = TweenService:Create(card, TweenInfo.new(0.25), {BackgroundTransparency = 1})
            tween:Play()
            tween.Completed:Connect(function()
                if card then card:Destroy() end
            end)
        end)
    end

    return notify
end

-- ================== Component Builder ==================
local Component = {}

local function makeControlFrame(container, h)
    local f = Instance.new("Frame")
    f.BackgroundColor3 = COLOR_SIDEBAR
    f.BorderSizePixel   = 0
    f.Size = UDim2.new(1, 0, 0, h)
    f.ZIndex = 1
    round(f, 6)
    f.Parent = container
    return f
end

function Component.Label(container, text, accent)
    local lbl = Instance.new("TextLabel")
    lbl.BackgroundTransparency = 1
    lbl.Font = Enum.Font.Gotham
    lbl.TextSize = 14
    lbl.TextColor3 = accent or COLOR_TEXT
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.Text = text or ""
    lbl.Size = UDim2.new(1, 0, 0, 20)
    lbl.ZIndex = 2
    lbl.Parent = container
    return lbl
end

function Component.Button(container, text, accent, callback)
    local btn = makeControlFrame(container, 32)

    local t = Instance.new("TextButton")
    t.BackgroundTransparency = 1
    t.AutoButtonColor = false   -- no glow
    t.Text = text or "Button"
    t.Font = Enum.Font.GothamBold
    t.TextSize = 16
    t.TextColor3 = accent
    t.Size = UDim2.new(1, -CTL_HPAD*2, 1, -8)
    t.Position = UDim2.new(0, CTL_HPAD, 0, 4)
    t.ZIndex = 2
    t.Parent = btn
    t.MouseButton1Click:Connect(function()
        if typeof(callback) == "function" then task.spawn(callback) end
    end)
    return btn
end

function Component.Toggle(container, text, accent, default, callback)
    local h = 32
    local frame = makeControlFrame(container, h)

    local box = Instance.new("TextButton")
    box.AutoButtonColor = false -- no glow
    box.Text = ""
    box.Size = UDim2.new(0,24,0,24)
    box.Position = UDim2.new(1,-(24 + CTL_HPAD),0,(h-24)/2)
    box.BackgroundColor3 = (default and accent) or COLOR_BG
    box.ZIndex = 2
    round(box,4)
    box.Parent = frame

    local mark = Instance.new("Frame")
    mark.Size = UDim2.new(1,0,1,0)
    mark.BackgroundColor3 = COLOR_BG
    mark.BackgroundTransparency = default and 1 or 0
    mark.ZIndex = 3
    round(mark,4)
    mark.Parent = box

    local lbl = Instance.new("TextLabel")
    lbl.BackgroundTransparency = 1
    lbl.Text = text or "Toggle"
    lbl.Font = Enum.Font.Gotham
    lbl.TextSize = 14
    lbl.TextColor3 = accent
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.Size = UDim2.new(1,-(24 + CTL_HPAD*2),1,0)
    lbl.Position = UDim2.new(0,CTL_HPAD,0,0)
    lbl.ZIndex = 2
    lbl.Parent = frame

    local state = not not default
    local function set(v)
        state = not not v
        box.BackgroundColor3 = state and accent or COLOR_BG
        mark.BackgroundTransparency = state and 1 or 0
        if typeof(callback) == "function" then callback(state) end
    end
    box.MouseButton1Click:Connect(function() set(not state) end)

    return { Instance = frame, Set = set, Get = function() return state end }
end

function Component.Slider(container, text, accent, min, max, default, callback)
    min, max = min or 0, max or 100
    if default == nil then default = min end

    local frame = makeControlFrame(container, 50)

    local lbl = Instance.new("TextLabel")
    lbl.BackgroundTransparency = 1
    lbl.Text = string.format("%s: %s", text or "Slider", tostring(default))
    lbl.Font = Enum.Font.Gotham
    lbl.TextSize = 14
    lbl.TextColor3 = accent
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.Size = UDim2.new(1,-(CTL_HPAD*2),0,18)
    lbl.Position = UDim2.new(0,CTL_HPAD,0,6)
    lbl.ZIndex = 2
    lbl.Parent = frame

    local bar = Instance.new("Frame")
    bar.BackgroundColor3 = COLOR_BG
    bar.BorderSizePixel = 0
    bar.Position = UDim2.new(0,CTL_HPAD,0,28)
    bar.Size = UDim2.new(1,-(CTL_HPAD*2),0,8)
    bar.ZIndex = 2
    round(bar, 4)
    bar.Parent = frame

    local fill = Instance.new("Frame")
    fill.BackgroundColor3 = accent
    fill.BorderSizePixel = 0
    fill.Size = UDim2.new((default-min)/(max-min),0,1,0)
    fill.ZIndex = 3
    round(fill, 4)
    fill.Parent = bar

    local dragging, value = false, default
    local function setFromX(x)
        local rel = math.clamp((x - bar.AbsolutePosition.X) / (bar.AbsoluteSize.X), 0, 1)
        value = math.floor(min + (max - min)*rel + 0.5)
        fill.Size = UDim2.new(rel, 0, 1, 0)
        lbl.Text = string.format("%s: %s", text or "Slider", tostring(value))
        if typeof(callback) == "function" then callback(value) end
    end
    bar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true; setFromX(input.Position.X)
        end
    end)
    bar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragging = false end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            setFromX(input.Position.X)
        end
    end)

    return {
        Instance = frame,
        Set = function(v)
            v = math.clamp(v, min, max)
            local rel = (v-min)/(max-min)
            fill.Size = UDim2.new(rel, 0, 1, 0)
            lbl.Text = string.format("%s: %s", text or "Slider", tostring(v))
            value = v
            if typeof(callback)=="function" then callback(value) end
        end,
        Get = function() return value end
    }
end

function Component.Dropdown(container, cfg)
    cfg = cfg or {}
    local title   = cfg.Title or "Dropdown"
    local values  = cfg.Values or {}
    local multi   = not not cfg.Multi
    local accent  = cfg.Accent or COLOR_TEXT
    local default = cfg.Default
    local onChanged = cfg.OnChanged

    local HEADER_H = 44 -- Höhe des geschlossenen Dropdown-Blocks

    local root = makeControlFrame(container, HEADER_H)
    root.ZIndex = 10

    local header = Instance.new("TextLabel")
    header.BackgroundTransparency = 1
    header.Text = title
    header.Font = Enum.Font.Gotham
    header.TextSize = 14
    header.TextColor3 = accent
    header.TextXAlignment = Enum.TextXAlignment.Left
    header.Size = UDim2.new(1,-(CTL_HPAD*2)-18,0,18)
    header.Position = UDim2.new(0,CTL_HPAD,0,6)
    header.ZIndex = 11
    header.Parent = root

    local arrowBtn = Instance.new("TextButton")
    arrowBtn.AutoButtonColor = false
    arrowBtn.BackgroundTransparency = 1
    arrowBtn.Text = "<"
    arrowBtn.Font = Enum.Font.GothamBold
    arrowBtn.TextSize = 16
    arrowBtn.TextColor3 = accent
    arrowBtn.Size = UDim2.new(0,18,0,18)
    arrowBtn.Position = UDim2.new(1,-(CTL_HPAD+18),0,6)
    arrowBtn.ZIndex = 11
    arrowBtn.Parent = root

    local valueBtn = Instance.new("TextButton")
    valueBtn.Text = "Select..."
    valueBtn.Font = Enum.Font.GothamBold
    valueBtn.TextSize = 14
    valueBtn.TextColor3 = accent
    valueBtn.BackgroundColor3 = COLOR_BG
    valueBtn.AutoButtonColor = false
    valueBtn.Size = UDim2.new(1,-(CTL_HPAD*2),0,18)
    valueBtn.Position = UDim2.new(0,CTL_HPAD,0,22)
    valueBtn.ZIndex = 11
    round(valueBtn, 4)
    valueBtn.Parent = root

    -- FIX: Panel direkt UNTER den Header setzen (Offset = HEADER_H), nicht Y.Scale=1
   local panel = Instance.new("Frame")
panel.BackgroundColor3 = COLOR_POPUP
panel.BorderSizePixel = 0
panel.ClipsDescendants = true
panel.Size = UDim2.new(1,0,0,0)
panel.Position = UDim2.new(0,0,0,HEADER_H) -- bleibt unter dem Header
panel.ZIndex = 30
round(panel,6)
panel.Parent = root

-- dezente Umrandung, damit der Hintergrund sichtbar ist
local stroke = Instance.new("UIStroke")
stroke.Thickness = 1
stroke.Color = Color3.fromRGB(40,40,40)
stroke.Transparency = 0.45
stroke.Parent = panel

    local listScroll = Instance.new("ScrollingFrame")
    listScroll.BackgroundTransparency = 1
    listScroll.Size = UDim2.new(1,0,1,0)
    listScroll.CanvasSize = UDim2.new(0,0,0,0)
    listScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
    listScroll.ScrollBarThickness = 4
    listScroll.ZIndex = 31
    listScroll.Parent = panel

    local listPad = Instance.new("UIPadding")
    listPad.PaddingLeft   = UDim.new(0,CTL_HPAD)
    listPad.PaddingRight  = UDim.new(0,CTL_HPAD)
    listPad.PaddingTop    = UDim.new(0,CTL_HPAD)
    listPad.PaddingBottom = UDim.new(0,CTL_HPAD)
    listPad.Parent = listScroll

    local list = Instance.new("UIListLayout")
    list.SortOrder = Enum.SortOrder.LayoutOrder
    list.Padding = UDim.new(0,6)
    list.Parent = listScroll
    list:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        listScroll.CanvasSize = UDim2.new(0,0,0, list.AbsoluteContentSize.Y + CTL_HPAD*2)
    end)

    local open, current = false, multi and {} or nil

    local function renderLabel()
        if multi then
            local c=0; for _,v in pairs(current) do if v then c+=1 end end
            valueBtn.Text = (c==0) and "Select..." or (c.." selected")
        else
            valueBtn.Text = current and tostring(current) or "Select..."
        end
    end

    local function fireChanged()
        if typeof(onChanged)=="function" then
            if multi then
                local t={} for k,v in pairs(current) do if v then table.insert(t,k) end end
                onChanged(t)
            else onChanged(current) end
        end
    end

    local function setOpen(v)
        if v==open then return end
        open = v
        arrowBtn.Text = open and "v" or "<"
        local rows = math.max(1,#values)
        local target = open and math.min(rows*28 + CTL_HPAD*2 + ((rows-1)*6), 180) or 0
        -- Panel bleibt bei Y=HEADER_H; wir erhöhen nur die ROOT-Höhe
        TweenService:Create(panel, TweenInfo.new(0.18), {Size = UDim2.new(1,0,0,target)}):Play()
        TweenService:Create(root,  TweenInfo.new(0.18), {Size = UDim2.new(1,0,0, HEADER_H + target)}):Play()
    end

    local function rebuild()
        for _,c in ipairs(listScroll:GetChildren()) do
            if c:IsA("TextButton") and c.Name=="DD_Item" then c:Destroy() end
        end
        for _,v in ipairs(values) do
            local item = Instance.new("TextButton")
            item.Name = "DD_Item"
            item.AutoButtonColor = false
            item.BackgroundColor3 = COLOR_BG
            item.TextColor3 = COLOR_TEXT
            item.TextXAlignment = Enum.TextXAlignment.Left
            item.Font = Enum.Font.Gotham
            item.TextSize = 14
            item.Size = UDim2.new(1,0,0,22)
            item.Text = tostring(v)
            item.ZIndex = 32
            round(item,4)
            item.Parent = listScroll

            local rightMark
            if multi then
                rightMark = Instance.new("TextLabel")
                rightMark.BackgroundTransparency = 1
                rightMark.Text = current[v] and "✓" or ""
                rightMark.Font = Enum.Font.GothamBold
                rightMark.TextSize = 14
                rightMark.TextColor3 = COLOR_TEXT
                rightMark.Size = UDim2.new(0,18,0,22)
                rightMark.Position = UDim2.new(1,-(CTL_HPAD+18),0,0)
                rightMark.ZIndex = 33
                rightMark.Parent = item
            end

            item.MouseButton1Click:Connect(function()
                if multi then
                    current[v] = not current[v]
                    if rightMark then rightMark.Text = current[v] and "✓" or "" end
                    renderLabel(); fireChanged()
                else
                    current = v
                    renderLabel(); fireChanged(); setOpen(false)
                end
            end)
        end
    end

    if multi and typeof(default)=="table" then
        for _,v in ipairs(default) do current[v]=true end
    elseif (not multi) and default~=nil then
        current = default
    end
    renderLabel(); rebuild()

    valueBtn.MouseButton1Click:Connect(function() setOpen(not open) end)
    arrowBtn.MouseButton1Click:Connect(function() setOpen(not open) end)
    header.InputBegan:Connect(function(i)
        if i.UserInputType==Enum.UserInputType.MouseButton1 then setOpen(not open) end
    end)

    -- Outside-Click -> schließen
    UserInputService.InputBegan:Connect(function(i,g)
        if g or not open then return end
        if i.UserInputType~=Enum.UserInputType.MouseButton1 and i.UserInputType~=Enum.UserInputType.Touch then return end
        local p = i.Position
        local a = panel.AbsolutePosition; local s = panel.AbsoluteSize
        if not (p.X>=a.X and p.X<=a.X+s.X and p.Y>=a.Y and p.Y<=a.Y+s.Y) then setOpen(false) end
    end)

    return {
        Instance  = root,
        Open      = function() setOpen(true) end,
        Close     = function() setOpen(false) end,
        SetValues = function(vs) values = vs or {}; rebuild(); if open then setOpen(true) end end,
        Set       = function(v)
            if multi then current = {}; if typeof(v)=="table" then for _,x in ipairs(v) do current[x]=true end end
            else current = v end
            renderLabel(); fireChanged()
        end,
        Get       = function()
            if multi then local t={} for k,v in pairs(current) do if v then table.insert(t,k) end end; return t
            else return current end
        end
    }
end


function Component.Dropbox(container, cfg)
    cfg = cfg or {}
    local title   = cfg.Title or "Dropbox"
    local values  = cfg.Values or {}
    local multi   = not not cfg.Multi
    local accent  = cfg.Accent or COLOR_TEXT
    local default = cfg.Default
    local onChanged = cfg.OnChanged
    local placeholder = cfg.Placeholder or "Type to filter..."

    local HEADER_H = 68 -- geschlossen (Label + Input)

    local root = makeControlFrame(container, HEADER_H)
    root.ZIndex = 20

    local header = Instance.new("TextLabel")
    header.BackgroundTransparency = 1
    header.Text = title
    header.Font = Enum.Font.Gotham
    header.TextSize = 14
    header.TextColor3 = accent
    header.TextXAlignment = Enum.TextXAlignment.Left
    header.Size = UDim2.new(1,-(CTL_HPAD*2)-18,0,18)
    header.Position = UDim2.new(0,CTL_HPAD,0,6)
    header.ZIndex = 21
    header.Parent = root

    local arrowBtn = Instance.new("TextButton")
    arrowBtn.AutoButtonColor = false
    arrowBtn.BackgroundTransparency = 1
    arrowBtn.Text = "<"
    arrowBtn.Font = Enum.Font.GothamBold
    arrowBtn.TextSize = 16
    arrowBtn.TextColor3 = accent
    arrowBtn.Size = UDim2.new(0,18,0,18)
    arrowBtn.Position = UDim2.new(1,-(CTL_HPAD+18),0,6)
    arrowBtn.ZIndex = 21
    arrowBtn.Parent = root

    local input = Instance.new("TextBox")
    input.Text = ""
    input.PlaceholderText = placeholder
    input.Font = Enum.Font.GothamBold
    input.TextSize = 14
    input.TextColor3 = accent
    input.BackgroundColor3 = COLOR_BG
    input.ClearTextOnFocus = false
    input.Size = UDim2.new(1,-(CTL_HPAD*2),0,22)
    input.Position = UDim2.new(0,CTL_HPAD,0,24)
    input.ZIndex = 21
    round(input, 4)
    input.Parent = root

    -- FIX: Panel direkt unter den Header/Input legen
   local panel = Instance.new("Frame")
panel.BackgroundColor3 = COLOR_POPUP
panel.BorderSizePixel = 0
panel.ClipsDescendants = true
panel.Size = UDim2.new(1,0,0,0)
panel.Position = UDim2.new(0,0,0,HEADER_H) -- bleibt unter dem Eingabebereich
panel.ZIndex = 40
round(panel,6)
panel.Parent = root

local stroke = Instance.new("UIStroke")
stroke.Thickness = 1
stroke.Color = Color3.fromRGB(40,40,40)
stroke.Transparency = 0.45
stroke.Parent = panel

    local listScroll = Instance.new("ScrollingFrame")
    listScroll.BackgroundTransparency = 1
    listScroll.Size = UDim2.new(1,0,1,0)
    listScroll.CanvasSize = UDim2.new(0,0,0,0)
    listScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
    listScroll.ScrollBarThickness = 4
    listScroll.ZIndex = 41
    listScroll.Parent = panel

    local listPad = Instance.new("UIPadding")
    listPad.PaddingLeft   = UDim.new(0,CTL_HPAD)
    listPad.PaddingRight  = UDim.new(0,CTL_HPAD)
    listPad.PaddingTop    = UDim.new(0,CTL_HPAD)
    listPad.PaddingBottom = UDim.new(0,CTL_HPAD)
    listPad.Parent = listScroll

    local list = Instance.new("UIListLayout")
    list.SortOrder = Enum.SortOrder.LayoutOrder
    list.Padding = UDim.new(0,6)
    list.Parent = listScroll
    list:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        listScroll.CanvasSize = UDim2.new(0,0,0, list.AbsoluteContentSize.Y + CTL_HPAD*2)
    end)

    local open, current = false, multi and {} or nil
    local filtered = {}

    local function filter(q)
        q = string.lower(q or "")
        table.clear(filtered)
        for _,v in ipairs(values) do
            if q == "" or string.find(string.lower(tostring(v)), q, 1, true) then
                table.insert(filtered, v)
            end
        end
        if #filtered == 0 then table.insert(filtered, "<no matches>") end
    end

    local function renderLabelFromCurrent()
        if multi then
            local c=0; for _,sel in pairs(current) do if sel then c+=1 end end
            input.PlaceholderText = (c==0) and placeholder or (c.." selected")
        else
            input.PlaceholderText = current and tostring(current) or placeholder
        end
    end

    local function fireChanged()
        if typeof(onChanged)=="function" then
            if multi then local t={} for k,v in pairs(current) do if v then table.insert(t,k) end end; onChanged(t)
            else onChanged(current) end
        end
    end

    local function setOpen(v)
        if v==open then return end
        open = v
        arrowBtn.Text = open and "v" or "<"
        local rows = math.max(1,#filtered)
        local target = open and math.min(rows*28 + CTL_HPAD*2 + ((rows-1)*6), 180) or 0
        TweenService:Create(panel, TweenInfo.new(0.18), {Size = UDim2.new(1,0,0,target)}):Play()
        TweenService:Create(root,  TweenInfo.new(0.18), {Size = UDim2.new(1,0,0, HEADER_H + target)}):Play()
    end

    local function rebuild()
        for _,c in ipairs(listScroll:GetChildren()) do
            if c:IsA("TextButton") and c.Name=="DB_Item" then c:Destroy() end
        end
        for _,v in ipairs(filtered) do
            local item = Instance.new("TextButton")
            item.Name = "DB_Item"
            item.AutoButtonColor = false
            item.BackgroundColor3 = COLOR_BG
            item.TextColor3 = COLOR_TEXT
            item.TextXAlignment = Enum.TextXAlignment.Left
            item.Font = Enum.Font.Gotham
            item.TextSize = 14
            item.Size = UDim2.new(1,0,0,22)
            item.Text = tostring(v)
            item.ZIndex = 42
            round(item,4)
            item.Parent = listScroll

            local rightMark
            if multi and v~="<no matches>" then
                rightMark = Instance.new("TextLabel")
                rightMark.BackgroundTransparency = 1
                rightMark.Text = current[v] and "✓" or ""
                rightMark.Font = Enum.Font.GothamBold
                rightMark.TextSize = 14
                rightMark.TextColor3 = COLOR_TEXT
                rightMark.Size = UDim2.new(0,18,0,22)
                rightMark.Position = UDim2.new(1,-(CTL_HPAD+18),0,0)
                rightMark.ZIndex = 43
                rightMark.Parent = item
            end

            item.MouseButton1Click:Connect(function()
                if v=="<no matches>" then return end
                if multi then
                    current[v] = not current[v]
                    if rightMark then rightMark.Text = current[v] and "✓" or "" end
                    renderLabelFromCurrent(); fireChanged()
                else
                    current = v
                    renderLabelFromCurrent(); fireChanged(); setOpen(false)
                end
            end)
        end
    end

    if multi and typeof(default)=="table" then
        for _,v in ipairs(default) do current[v]=true end
    elseif (not multi) and default~=nil then
        current = default
    end
    filter("")
    renderLabelFromCurrent()
    rebuild()

    input.Focused:Connect(function() setOpen(true) end)
    input.FocusLost:Connect(function() setOpen(false) end)
    input:GetPropertyChangedSignal("Text"):Connect(function()
        filter(input.Text or ""); rebuild(); if not open then setOpen(true) end
    end)
    arrowBtn.MouseButton1Click:Connect(function() setOpen(not open) end)
    header.InputBegan:Connect(function(i)
        if i.UserInputType==Enum.UserInputType.MouseButton1 then setOpen(not open) end
    end)

    UserInputService.InputBegan:Connect(function(i,g)
        if g or not open then return end
        if i.UserInputType~=Enum.UserInputType.MouseButton1 and i.UserInputType~=Enum.UserInputType.Touch then return end
        local p=i.Position; local a=panel.AbsolutePosition; local s=panel.AbsoluteSize
        if not (p.X>=a.X and p.X<=a.X+s.X and p.Y>=a.Y and p.Y<=a.Y+s.Y) then setOpen(false) end
    end)

    return {
        Instance  = root,
        Open      = function() setOpen(true) end,
        Close     = function() setOpen(false) end,
        SetValues = function(vs) values = vs or {}; filter(input.Text or ""); rebuild(); if open then setOpen(true) end end,
        Set       = function(v)
            if multi then current = {}; if typeof(v)=="table" then for _,x in ipairs(v) do current[x]=true end end
            else current = v end
            renderLabelFromCurrent(); fireChanged()
        end,
        Get       = function()
            if multi then local t={} for k,v in pairs(current) do if v then table.insert(t,k) end end; return t
            else return current end
        end
    }
end

-- ================== Window / Tabs ==================
function VanithUI.CreateWindow(opts)
    opts = opts or {}
    local width  = opts.Width  or BASE_W
    local height = opts.Height or BASE_H
    local hue    = (opts.Hue ~= nil) and opts.Hue or DEFAULT_HUE
    local accent = Color3.fromHSV(hue,1,1)
    local title  = opts.Title or "Vanith | Eternal Nights"
    local version= opts.Version or "v1.0.3"
    local discordURL = opts.DiscordURL
    local onUnlockFPS = opts.OnUnlockFPS or function() end
    local IS_MOBILE = UserInputService.TouchEnabled

    local root = Instance.new("ScreenGui")
    root.Name = "VanithUI_Exact_v7f"
    root.ResetOnSpawn = false
    root.IgnoreGuiInset = true
    root.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    root.Parent = getRoot()

    local notify = createNotifier(root, accent)

    local main = Instance.new("Frame")
    main.Name = "MainWindow"
    main.Size = UDim2.new(0,width,0,height)
    main.Position = START_POS
    main.BackgroundColor3 = COLOR_BG
    main.BorderSizePixel = 0
    round(main,6)
    main.Parent = root

    -- Topbar
    local top = Instance.new("Frame")
    top.Size = UDim2.new(1,0,0,TOP_H)
    top.BackgroundTransparency = 1
    top.Parent = main

    local titleLbl = Instance.new("TextLabel")
    titleLbl.Text = title
    titleLbl.Font = Enum.Font.GothamBold
    titleLbl.TextSize = 16
    titleLbl.TextColor3 = accent
    titleLbl.BackgroundTransparency = 1
    titleLbl.Position = UDim2.new(0,12,0,0)
    titleLbl.Size = UDim2.new(1,-100,1,0)
    titleLbl.TextXAlignment = Enum.TextXAlignment.Left
    titleLbl.Parent = top

    local btnMin = Instance.new("TextButton")
    btnMin.Text = "_"
    btnMin.Font = Enum.Font.GothamBold
    btnMin.TextSize = 20
    btnMin.TextColor3 = accent
    btnMin.BackgroundTransparency = 1
    btnMin.AutoButtonColor = false
    btnMin.Size = UDim2.new(0,28,0,TOP_H)
    btnMin.Position = UDim2.new(1,-60,0,0)
    btnMin.Parent = top

    local btnClose = Instance.new("TextButton")
    btnClose.Text = "X"
    btnClose.Font = Enum.Font.GothamBold
    btnClose.TextSize = 18
    btnClose.TextColor3 = accent
    btnClose.BackgroundTransparency = 1
    btnClose.AutoButtonColor = false
    btnClose.Size = UDim2.new(0,28,0,TOP_H)
    btnClose.Position = UDim2.new(1,-32,0,0)
    btnClose.Parent = top

    -- Drag (mouse + touch)
    do
        local dragging, dragInput, dragStart, startPos
        top.InputBegan:Connect(function(i)
            if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then
                dragging, dragStart, startPos = true, i.Position, main.Position
                i.Changed:Connect(function()
                    if i.UserInputState==Enum.UserInputState.End then dragging=false end
                end)
            end
        end)
        top.InputChanged:Connect(function(i)
            if i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch then
                dragInput = i
            end
        end)
        UserInputService.InputChanged:Connect(function(i)
            if dragging and i==dragInput then
                local d = i.Position - dragStart
                main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + d.X, startPos.Y.Scale, startPos.Y.Offset + d.Y)
            end
        end)
    end

    btnClose.MouseButton1Click:Connect(function() root:Destroy() end)

    -- Sidebar / Content
    local sidebar = Instance.new("Frame")
    sidebar.Size = UDim2.new(0,100,1,-TOP_H)
    sidebar.Position = UDim2.new(0,0,0,TOP_H)
    sidebar.BackgroundColor3 = COLOR_SIDEBAR
    sidebar.BorderSizePixel = 0
    round(sidebar,4)
    sidebar.Parent = main

    local content = Instance.new("Frame")
    content.Size = UDim2.new(1,-100,1,-TOP_H)
    content.Position = UDim2.new(0,100,0,TOP_H)
    content.BackgroundColor3 = COLOR_PANEL
    content.BorderSizePixel = 0
    round(content,4)
    content.Parent = main

    local pages, scrolls, tabButtons, order = {}, {}, {}, {}
    local activeTab = "Main"

    local function showPage(name)
        activeTab = name
        for t,p in pairs(pages) do p.Visible = (t==name) end
        for t,b in pairs(tabButtons) do b.TextColor3 = (t==name) and accent or COLOR_TEXT end
    end

    local function createTabButton(name, index)
        local b = Instance.new("TextButton")
        b.Name = name.."Tab"
        b.Text = name
        b.Font = Enum.Font.Gotham
        b.TextSize = 16
        b.TextColor3 = (name==activeTab) and accent or COLOR_TEXT
        b.BackgroundTransparency = 1
        b.AutoButtonColor = false
        b.Size = UDim2.new(1,0,0, UserInputService.TouchEnabled and 38 or 32)
        b.Position = UDim2.new(0,0,0,(index-1)*(UserInputService.TouchEnabled and 42 or 36))
        b.Parent = sidebar
        b.MouseButton1Click:Connect(function() showPage(name) end)
        tabButtons[name] = b
        return b
    end

    local function createPage(name, withPadding)
        local p = Instance.new("Frame")
        p.Name = name.."Page"
        p.Size = UDim2.new(1,0,1,0)
        p.BackgroundTransparency = 1
        p.Visible = (name==activeTab)
        p.Parent = content

        local scroll = Instance.new("ScrollingFrame")
        scroll.Size = UDim2.new(1,0,1,0)
        scroll.BackgroundTransparency = 1
        scroll.CanvasSize = UDim2.new(0,0,0,0)
        scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
        scroll.ScrollBarThickness = UserInputService.TouchEnabled and 6 or 0
        scroll.ScrollingDirection = Enum.ScrollingDirection.Y
        scroll.Parent = p

        if withPadding then
            local pad = Instance.new("UIPadding")
            pad.PaddingLeft   = UDim.new(0,INNER_PAD)
            pad.PaddingRight  = UDim.new(0,INNER_PAD)
            pad.PaddingTop    = UDim.new(0,INNER_PAD)
            pad.PaddingBottom = UDim.new(0,INNER_PAD)
            pad.Parent = scroll

            local list = Instance.new("UIListLayout")
            list.SortOrder = Enum.SortOrder.LayoutOrder
            list.Padding = UDim.new(0,CTL_GAP)
            list.Parent = scroll

            list:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                scroll.CanvasSize = UDim2.new(0,0,0, list.AbsoluteContentSize.Y + INNER_PAD*2)
            end)
        end

        pages[name], scrolls[name] = p, scroll
        return p, scroll
    end

    local function addTab(name, withPadding)
        if pages[name] then return end
        table.insert(order, name)
        createTabButton(name, #order)
        createPage(name, withPadding)
    end

    -- Main page exists (no padding)
    addTab("Main", false)

    local function addTabPublic(name, withPaddingIfNew)
        if not pages[name] then
            table.insert(order, name)
            createTabButton(name, #order)
            createPage(name, withPaddingIfNew)
        else
            if not tabButtons[name] then
                table.insert(order, name)
                createTabButton(name, #order)
            end
        end
    end
    addTabPublic("Main", false)

    -- ===== Main content (avatar + stats + changelog) =====
    local changelogLabel
    do
        local pad = 16
        local scroll = scrolls.Main

        local left = Instance.new("Frame")
        left.Size = UDim2.new(0,300,0,110)
        left.Position = UDim2.new(0,pad,0,pad)
        left.BackgroundColor3 = COLOR_SIDEBAR
        left.BorderSizePixel = 0
        round(left,8)
        left.Parent = scroll

        local avatar = Instance.new("ImageLabel")
        avatar.Size = UDim2.new(0,64,0,64)
        avatar.Position = UDim2.new(0,16,0,16)
        avatar.BackgroundTransparency = 1
        round(avatar,32)
        avatar.Parent = left
        task.spawn(function()
            local lp = Players.LocalPlayer
            local img = Players:GetUserThumbnailAsync(lp.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size100x100)
            avatar.Image = img
        end)

        local info = Instance.new("Frame")
        info.BackgroundTransparency = 1
        info.Position = UDim2.new(0, 96, 0, 8)
        info.Size = UDim2.new(1, -110, 1, -16)
        info.Parent = left

        local nameLbl = Instance.new("TextLabel")
        nameLbl.Text = Players.LocalPlayer.Name
        nameLbl.Font = Enum.Font.GothamBold
        nameLbl.TextSize = 20
        nameLbl.TextColor3 = accent
        nameLbl.BackgroundTransparency = 1
        nameLbl.TextXAlignment = Enum.TextXAlignment.Left
        nameLbl.Size = UDim2.new(1, 0, 0, 24)
        nameLbl.Position = UDim2.new(0, 0, 0, 2)
        nameLbl.Parent = info

        local verLbl = Instance.new("TextLabel")
        verLbl.Text = "Version: "..tostring(version)
        verLbl.Font = Enum.Font.Gotham
        verLbl.TextSize = 14
        verLbl.TextColor3 = accent
        verLbl.BackgroundTransparency = 1
        verLbl.TextXAlignment = Enum.TextXAlignment.Left
        verLbl.Size = UDim2.new(1, 0, 0, 18)
        verLbl.Position = UDim2.new(0, 0, 0, 26)
        verLbl.Parent = info

        local joinBtn = Instance.new("TextButton")
        joinBtn.Text = "Join Discord"
        joinBtn.Font = Enum.Font.GothamBold
        joinBtn.TextSize = 16
        joinBtn.TextColor3 = accent
        joinBtn.BackgroundColor3 = COLOR_SIDEBAR
        joinBtn.AutoButtonColor = false
        joinBtn.Size = UDim2.new(0, 160, 0, 28)
        joinBtn.Position = UDim2.new(0, 0, 0, 70)
        round(joinBtn,6)
        joinBtn.Parent = info
        joinBtn.MouseButton1Click:Connect(function()
            if discordURL and setclipboard then pcall(function() setclipboard(discordURL) end) end
            notify("Discord", discordURL and "Invite kopiert" or "Kein Link gesetzt", 1.6)
        end)

        local right = Instance.new("Frame")
        right.Size = UDim2.new(0,200,0,110)
        right.Position = UDim2.new(1,-(200+pad),0,pad)
        right.BackgroundColor3 = COLOR_SIDEBAR
        right.BorderSizePixel = 0
        round(right,8)
        right.Parent = scroll

        local fpsLbl = Instance.new("TextLabel")
        fpsLbl.Text = "FPS: —"
        fpsLbl.Font = Enum.Font.Gotham
        fpsLbl.TextSize = 16
        fpsLbl.TextColor3 = accent
        fpsLbl.BackgroundTransparency = 1
        fpsLbl.Position = UDim2.new(0,8,0,18)
        fpsLbl.Size = UDim2.new(1,-16,0,20)
        fpsLbl.TextXAlignment = Enum.TextXAlignment.Left
        fpsLbl.Parent = right

        local pingLbl = fpsLbl:Clone()
        pingLbl.Text = "Ping: —"
        pingLbl.Position = UDim2.new(0,8,0,44)
        pingLbl.Parent = right

        local unlockBtn = Instance.new("TextButton")
        unlockBtn.Text = "Unlock FPS"
        unlockBtn.Font = Enum.Font.GothamBold
        unlockBtn.TextSize = 16
        unlockBtn.TextColor3 = accent
        unlockBtn.BackgroundColor3 = COLOR_SIDEBAR
        unlockBtn.AutoButtonColor = false
        unlockBtn.Size = UDim2.new(1,-16,0,28)
        unlockBtn.Position = UDim2.new(0,8,0,74)
        round(unlockBtn,6)
        unlockBtn.Parent = right
        unlockBtn.MouseButton1Click:Connect(function() onUnlockFPS() end)

        local logCard = Instance.new("Frame")
        logCard.BackgroundColor3 = COLOR_SIDEBAR
        logCard.BorderSizePixel = 0
        logCard.Position = UDim2.new(0,pad,0, 110 + pad*2)
        logCard.Size = UDim2.new(1,-pad*2,0,120)
        round(logCard,8)
        logCard.Parent = scroll

        local changelogLabelRef = Instance.new("TextLabel")
        changelogLabelRef.Font = Enum.Font.Gotham
        changelogLabelRef.TextSize = 14
        changelogLabelRef.TextColor3 = accent
        changelogLabelRef.BackgroundTransparency = 1
        changelogLabelRef.TextXAlignment = Enum.TextXAlignment.Left
        changelogLabelRef.TextYAlignment = Enum.TextYAlignment.Top
        changelogLabelRef.TextWrapped = true
        changelogLabelRef.Text = "Changelog (UI):\n- Dropdown/Dropbox capped\n- No glow\n- High ZIndex"
        changelogLabelRef.Position = UDim2.new(0,12,0,10)
        changelogLabelRef.Size = UDim2.new(1,-24,1,-20)
        changelogLabelRef.Parent = logCard
        changelogLabel = changelogLabelRef

        local fpsSmooth, last = 60, tick()
        RunService.Heartbeat:Connect(function()
            local now = tick(); local dt = now-last; last=now
            if dt>0 then fpsSmooth = fpsSmooth*0.9 + (1/dt)*0.1 end
            fpsLbl.Text = ("FPS: %d"):format(math.floor(fpsSmooth+0.5))
        end)
        task.spawn(function()
            while root.Parent do
                local p = getPingMs()
                pingLbl.Text = p and ("Ping: %d ms"):format(p) or "Ping: —"
                task.wait(0.5)
            end
        end)
    end

    -- Minimize / Restore
    local minimized, miniFrame = false, nil
    local function makeMini()
        local m = Instance.new("Frame")
        m.Name = "MiniIcon"
        m.Size = UDim2.new(0,50,0,50)
        m.Position = main.Position
        m.BackgroundColor3 = COLOR_BG
        m.BorderSizePixel = 0
        round(m,4)
        m.Parent = root

        local icon = Instance.new("TextLabel")
        icon.Text = "❄️"
        icon.Font = Enum.Font.GothamBold
        icon.TextSize = 28
        icon.TextColor3 = Color3.fromHSV(0,0,1)
        icon.BackgroundTransparency = 1
        icon.Size = UDim2.new(1,0,1,0)
        icon.TextXAlignment = Enum.TextXAlignment.Center
        icon.TextYAlignment = Enum.TextYAlignment.Center
        icon.Parent = m

        local dragging, dragInput, dragStart, startPos, moved = false, nil, nil, nil, false
        m.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true; moved = false
                dragStart = input.Position; startPos = m.Position
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then dragging = false end
                end)
            end
        end)
        m.InputChanged:Connect(function(input)
            if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                local d = input.Position - dragStart
                if not moved and (math.abs(d.X)>5 or math.abs(d.Y)>5) then moved = true end
                m.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + d.X, startPos.Y.Scale, startPos.Y.Offset + d.Y)
            end
        end)
        m.InputEnded:Connect(function(input)
            if (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
                if not moved then
                    minimized = false
                    m:Destroy()
                    main.Visible = true
                    btnMin.Text = "_"
                end
            end
        end)
        return m
    end

    btnMin.MouseButton1Click:Connect(function()
        if minimized then
            minimized = false
            if miniFrame then miniFrame:Destroy() end
            main.Visible = true
            btnMin.Text = "_"
        else
            minimized = true
            main.Visible = false
            miniFrame = makeMini()
            btnMin.Text = "⬆"
        end
    end)

    -- Tabs API
    local tabs = {}
    local function makeTabObj(name)
        local scroll = scrolls[name]
        local Tab = {}
        function Tab:AddLabel(text) return Component.Label(scroll, text, accent) end
        function Tab:AddButton(text, cb) return Component.Button(scroll, text, accent, cb) end
        function Tab:AddToggle(text, def, cb) return Component.Toggle(scroll, text, accent, def, cb) end
        function Tab:AddSlider(text, mi, ma, de, cb) return Component.Slider(scroll, text, accent, mi, ma, de, cb) end
        function Tab:AddDropdown(config) config = config or {}; config.Accent = accent; return Component.Dropdown(scroll, config) end
        function Tab:AddDropbox(config) config = config or {}; config.Accent = accent; return Component.Dropbox(scroll, config) end
        function Tab:GetContainer() return scroll end
        function Tab:GetName() return name end
        tabs[name] = Tab; return Tab
    end

    local function tabCount() local c=0; for _ in pairs(pages) do c+=1 end; return c end
    local function addTabPublic(name)
        if not pages[name] then
            table.insert(order, name)
            createTabButton(name, #order)
            createPage(name, true)
        else
            if not tabButtons[name] then
                table.insert(order, name)
                createTabButton(name, #order)
            end
        end
    end

    addTabPublic("Main")
    makeTabObj("Main")

    local window = {}

    function window:ShowTab(name) if pages[name] then showPage(name) end end
    function window:GetTab(name) return tabs[name] end
    function window:CreateTab(name)
        name = tostring(name or ""):gsub("^%s+",""):gsub("%s+$","")
        if name=="" or pages[name] then return tabs[name] end
        if tabCount() >= MAX_TABS then warn("[VanithUI] Tab limit reached.") return nil end
        addTabPublic(name); makeTabObj(name); showPage(name); return tabs[name]
    end
    function window:GetTabCount() return tabCount() end

    -- Theming/Meta
    function window:SetHue(h)
        h = tonumber(h) or DEFAULT_HUE; h = math.clamp(h,0,1)
        local newAccent = Color3.fromHSV(h,1,1)
        for n,b in pairs(tabButtons) do b.TextColor3 = (n==activeTab) and newAccent or COLOR_TEXT end
        titleLbl.TextColor3 = newAccent
        -- update closures to use new accent
        accent = newAccent
    end
    function window:SetTitle(t) titleLbl.Text = tostring(t or "") end
    function window:SetDiscordURL(url) discordURL = tostring(url or "") end
    function window:SetChangelog(text) if changelogLabel then changelogLabel.Text = tostring(text or "") end end
    function window:SetChangelogLines(lines) if changelogLabel and typeof(lines)=="table" then changelogLabel.Text = table.concat(lines,"\n") end end
    function window:Notify(t,m,d) local n = createNotifier(root, accent); n(tostring(t or ""), tostring(m or ""), tonumber(d) or 2) end
    function window:GetRoot() return root end
    function window:Destroy() root:Destroy() end

    -- Toggle with M (desktop)
    UserInputService.InputBegan:Connect(function(i,g)
        if not g and i.KeyCode==Enum.KeyCode.M then root.Enabled = not root.Enabled end
    end)

    -- Default
    showPage("Main")

    return window
end

return VanithUI
