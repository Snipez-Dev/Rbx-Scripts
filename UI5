local Players          = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService     = game:GetService("TweenService")

local Vanith = {}

--------------------------------------------------------------------- -- helpers
--------------------------------------------------------------------- 

local function New(className, props)
    local inst = Instance.new(className)
    if props then
        for k, v in pairs(props) do
            inst[k] = v
        end
    end
    return inst
end

local function IsMouse(t)
    return t == Enum.UserInputType.MouseButton1
        or t == Enum.UserInputType.MouseButton2
        or t == Enum.UserInputType.MouseButton3
end

local function IsTouch(t)
    return t == Enum.UserInputType.Touch
end

local function Clamp01(x)
    return math.clamp(x, 0, 1)
end

local function RoundStep(v, minv, step)
    if not step or step <= 0 then return v end
    local n = (v - minv) / step
    return (math.floor(n + 0.5) * step) + minv
end

local function PlayTween(inst, props, time)
    if not inst then return end
    time = time or 0.15
    local ok, tween = pcall(
        TweenService.Create,
        TweenService,
        inst,
        TweenInfo.new(time, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
        props
    )
    if ok and tween then tween:Play() end
end

--------------------------------------------------------------------- -- theme
--------------------------------------------------------------------- 

local DEFAULT_THEME = {
    Accent  = Color3.fromRGB(170, 90, 255),
    BG0     = Color3.fromRGB(4, 4, 6),
    BG1     = Color3.fromRGB(10, 10, 14),
    BG2     = Color3.fromRGB(10, 10, 14),
    Stroke  = Color3.fromRGB(40, 40, 50),
    Text    = Color3.fromRGB(230, 230, 238),
    Muted   = Color3.fromRGB(140, 140, 150),
    DimText = Color3.fromRGB(95, 95, 110),
    Track   = Color3.fromRGB(22, 22, 28),
    Field   = Color3.fromRGB(16, 16, 20),
}

local Window  = {}
Window.__index = Window

local Tab     = {}
Tab.__index   = Tab

local Section = {}
Section.__index = Section

--------------------------------------------------------------------- -- window helpers
--------------------------------------------------------------------- 

function Window:_track(inst, prop, key)
    table.insert(self._themeBindings, {inst = inst, prop = prop, key = key})
    inst[prop] = self.Theme[key]
    return inst
end

function Window:ApplyTheme()
    for _, b in ipairs(self._themeBindings) do
        if b.inst and b.inst.Parent then
            b.inst[b.prop] = self.Theme[b.key]
        end
    end
end

function Window:SetTheme(tbl)
    for k, v in pairs(tbl or {}) do
        self.Theme[k] = v
    end
    self:ApplyTheme()
end

function Window:SetAccent(color)
    self.Theme.Accent = color
    self:ApplyTheme()
end

function Window:SetVisible(state)
    if self.Main then
        self.Main.Visible = state and true or false
    end
end

function Window:Destroy()
    if self.Gui then
        self.Gui:Destroy()
    end
end

-- drag top bar
function Window:_enableDrag(handle, target)
    local dragging
    local dragStart
    local startPos
    local activeInput

    local function update(input)
        if not dragging then return end
        local posDelta = input.Position - dragStart
        target.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset + posDelta.X,
            startPos.Y.Scale, startPos.Y.Offset + posDelta.Y
        )
    end

    handle.InputBegan:Connect(function(input)
        if IsMouse(input.UserInputType) or IsTouch(input.UserInputType) then
            dragging    = true
            activeInput = input
            dragStart   = input.Position
            startPos    = target.Position

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging    = false
                    activeInput = nil
                end
            end)
        end
    end)

    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement
            or input.UserInputType == Enum.UserInputType.Touch then
            activeInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == activeInput then
            update(input)
        end
    end)
end

-- resize bottom right, minSize = creation size
function Window:_enableResize(handle, target)
    local minSize = self.MinSize or Vector2.new(649, 417)

    local resizing
    local dragStart
    local startSize
    local activeInput

    local function update(input)
        if not resizing then return end
        local delta = input.Position - dragStart
        local newSize = Vector2.new(
            math.max(minSize.X, startSize.X + delta.X),
            math.max(minSize.Y, startSize.Y + delta.Y)
        )
        target.Size = UDim2.fromOffset(newSize.X, newSize.Y)
    end

    handle.InputBegan:Connect(function(input)
        if IsMouse(input.UserInputType) or IsTouch(input.UserInputType) then
            resizing    = true
            activeInput = input
            dragStart   = input.Position
            startSize   = Vector2.new(target.AbsoluteSize.X, target.AbsoluteSize.Y)

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    resizing    = false
                    activeInput = nil
                end
            end)
        end
    end)

    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement
            or input.UserInputType == Enum.UserInputType.Touch then
            activeInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == activeInput then
            update(input)
        end
    end)
end

-- internal: top weapon-tab button
function Window:_makeTopTabButton(text)
    local holder = self.TopTabsHolder

    local btn = New("TextButton", {
        AutoButtonColor = false,
        BackgroundTransparency = 1,
        Text = "",
        Size = UDim2.new(0, 0, 1, 0),
        AutomaticSize = Enum.AutomaticSize.X,
        Parent = holder,
        ZIndex = 4,
    })

    local label = New("TextLabel", {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = text,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Center,
        Parent = btn,
        ZIndex = 5,
        TextColor3 = self.Theme.DimText,
    })

    local underline = New("Frame", {
        BorderSizePixel = 0,
        Size = UDim2.new(0.7, 0, 0, 2),
        Position = UDim2.new(0.15, 0, 1, -3),
        Parent = btn,
        Visible = false,
        ZIndex = 4,
        BackgroundColor3 = self.Theme.Accent,
    })

    local t = {Button = btn, Label = label, Underline = underline, Tab = nil}
    table.insert(self.TopTabs, t)
    return t
end

--------------------------------------------------------------------- -- left nav tabs
--------------------------------------------------------------------- 

function Window:CreateTab(name)
    local row = New("TextButton", {
        AutoButtonColor = false,
        BackgroundTransparency = 1,
        Text = "",
        Size = UDim2.new(1, -20, 0, 38),
        Parent = self.SideList,
        ZIndex = 2,
    })

    local bg = New("Frame", {
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 1, 0),
        Parent = row,
        ZIndex = 1,
    })
    self:_track(bg, "BackgroundColor3", "BG2")

    local accent = New("Frame", {
        BorderSizePixel = 0,
        Size = UDim2.new(0, 2, 0.6, 0),
        Position = UDim2.new(0, 0, 0.2, 0),
        Parent = row,
        Visible = false,
        ZIndex = 2,
    })
    self:_track(accent, "BackgroundColor3", "Accent")

    local label = New("TextLabel", {
        BackgroundTransparency = 1,
        Position = UDim2.fromOffset(10, 8),
        Size = UDim2.new(1, -20, 0, 22),
        Font = Enum.Font.GothamBold,
        Text = name,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = row,
        ZIndex = 3,
    })
    self:_track(label, "TextColor3", "Muted")

    local page = New("Frame", {
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 1, 0),
        Visible = false,
        Parent = self.Pages,
        ZIndex = 1,
    })

    local tab = setmetatable({
        Window        = self,
        Name          = name,
        Row           = row,
        Label         = label,
        Accent        = accent,
        Bg            = bg,
        Page          = page,
        _sections     = {},
        _topTabs      = {},
        _activeTopTab = nil,
    }, Tab)

    row.MouseButton1Click:Connect(function()
        self:SelectTab(tab)
    end)

    table.insert(self.Tabs, tab)
    if #self.Tabs == 1 then
        self:SelectTab(tab)
    end

    return tab
end

function Window:SelectTab(tab)
    self.ActiveTab = tab

    for _, t in ipairs(self.Tabs) do
        local active = (t == tab)

        t.Page.Visible = active

        PlayTween(t.Bg, {BackgroundTransparency = active and 0 or 1}, 0.12)
        t.Accent.Visible = active
        PlayTween(t.Label, {TextColor3 = active and self.Theme.Text or self.Theme.Muted}, 0.12)

        for _, topTab in ipairs(t._topTabs) do
            topTab.Button.Visible = active
        end
    end

    if tab._activeTopTab then
        tab:SetTopTab(tab._activeTopTab)
    end
end

--------------------------------------------------------------------- -- tab methods (weapon tabs + sections)
--------------------------------------------------------------------- 

function Tab:CreateTopTab(name)
    local win = self.Window
    local tt  = win:_makeTopTabButton(name)
    tt.Tab    = self

    table.insert(self._topTabs, tt)
    tt.Button.Visible = (win.ActiveTab == self)

    tt.Button.MouseButton1Click:Connect(function()
        self:SetTopTab(tt)
    end)

    if not self._activeTopTab then
        self:SetTopTab(tt)
    end

    return tt
end

function Tab:SetTopTab(tt)
    self._activeTopTab = tt
    local win = self.Window

    for _, other in ipairs(self._topTabs) do
        local active = (other == tt)
        other.Underline.Visible = active and (win.ActiveTab == self)
        PlayTween(other.Label, {
            TextColor3 = active and win.Theme.Accent or win.Theme.DimText
        }, 0.12)
    end

    if self._sections then
        for _, sec in ipairs(self._sections) do
            if sec._controls then
                for _, ctrl in ipairs(sec._controls) do
                    if ctrl._syncProfile then
                        ctrl:_syncProfile()
                    end
                end
            end
        end
    end
end

function Tab:GetActiveTopTabName()
    return self._activeTopTab and self._activeTopTab.Label.Text or nil
end

-- slot: "LeftTop", "LeftBottom", "RightTop", "RightBottom"
function Tab:CreateSection(title, slot)
    local win  = self.Window
    local page = self.Page

    ------------------------------------------------------------------
    -- Layout
    ------------------------------------------------------------------
    local layout = {
        LeftTop = {
            Pos  = UDim2.new(0, 0, 0, 0),
            Size = UDim2.new(0.7, -6, 0.5, -6),
        },
        LeftBottom = {
            Pos  = UDim2.new(0, 0, 0.5, 6),
            Size = UDim2.new(0.7, -6, 0.5, -6),
        },
        RightTop = {
            Pos  = UDim2.new(0.7, 6, 0, 0),
            Size = UDim2.new(0.3, -6, 0.5, -6),
        },
        RightBottom = {
            Pos  = UDim2.new(0.7, 6, 0.5, 6),
            Size = UDim2.new(0.3, -6, 0.5, -6),
        },
    }

    local info  = layout[slot or ""]
    local props = {BorderSizePixel = 0, Parent = page, ClipsDescendants = true}

    if info then
        props.Position = info.Pos
        props.Size     = info.Size
    else
        local idx = #self._sections
        props.Position = UDim2.fromOffset(0, idx * 196)
        props.Size     = UDim2.new(1, 0, 0, 180)
    end

    local frame = New("Frame", props)
    win:_track(frame, "BackgroundColor3", "BG1")
    New("UICorner", {CornerRadius = UDim.new(0, 8), Parent = frame})
    local stroke = New("UIStroke", {Thickness = 1, Transparency = 0.25, Parent = frame})
    win:_track(stroke, "Color", "Stroke")

    local head = New("TextLabel", {
        BackgroundTransparency = 1,
        Position = UDim2.fromOffset(12, 10),
        Size = UDim2.new(1, -24, 0, 18),
        Font = Enum.Font.GothamBold,
        Text = title,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = frame,
    })
    win:_track(head, "TextColor3", "Accent")

    local inner = New("ScrollingFrame", {
        BorderSizePixel = 0,
        BackgroundTransparency = 1,
        Position = UDim2.fromOffset(0, 34),
        Size = UDim2.new(1, 0, 1, -34),
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ScrollBarThickness = 3,
        ScrollBarImageTransparency = 0.3,
        ScrollBarImageColor3 = win.Theme.Accent,
        ScrollingDirection = Enum.ScrollingDirection.Y,
        Parent = frame,
    })

    local list = New("UIListLayout", {
        Padding = UDim.new(0, 10),
        SortOrder = Enum.SortOrder.LayoutOrder,
        Parent = inner,
    })
    New("UIPadding", {
        PaddingTop = UDim.new(0, 6),
        PaddingLeft = UDim.new(0, 12),
        PaddingRight = UDim.new(0, 12),
        PaddingBottom = UDim.new(0, 10),
        Parent = inner,
    })

    list:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        inner.CanvasSize = UDim2.new(0, 0, 0, list.AbsoluteContentSize.Y + 16)
    end)

    local sec = setmetatable({
        Window    = win,
        Tab       = self,
        Frame     = frame,
        Inner     = inner,
        List      = list,
        _controls = {},
    }, Section)

    table.insert(self._sections, sec)

    return sec
end

--------------------------------------------------------------------- -- section controls
--------------------------------------------------------------------- 

function Section:CreateSlider(cfg)
    local win   = self.Window
    local inner = self.Inner
    local tab   = self.Tab
    local c     = cfg or {}

    local minv  = c.Min or 0
    local maxv  = c.Max or 100
    local step  = c.Step or 1

    local function getProfileKey()
        if tab and tab._activeTopTab then
            return tab._activeTopTab
        end
        return "__default"
    end

    local valuesByProfile = {}

    local defaultValue = RoundStep(math.clamp(c.Default or minv, minv, maxv), minv, step)
    local value        = defaultValue
    valuesByProfile[getProfileKey()] = defaultValue

    local row = New("Frame", {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 54),
        Parent = inner,
    })

    local label = New("TextLabel", {
        BackgroundTransparency = 1,
        Size = UDim2.new(0.6, 0, 0, 18),
        Font = Enum.Font.Gotham,
        Text = c.Name or "Slider",
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = row,
    })
    win:_track(label, "TextColor3", "DimText")

    local valueText = New("TextLabel", {
        BackgroundTransparency = 1,
        Position = UDim2.new(0.6, 0, 0, 0),
        Size = UDim2.new(0.4, 0, 0, 18),
        Font = Enum.Font.GothamBold,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Right,
        Parent = row,
    })
    win:_track(valueText, "TextColor3", "Accent")

    local track = New("Frame", {
        BorderSizePixel = 0,
        Position = UDim2.fromOffset(0, 26),
        Size = UDim2.new(1, 0, 0, 4),
        Parent = row,
    })
    win:_track(track, "BackgroundColor3", "Track")
    New("UICorner", {CornerRadius = UDim.new(0, 2), Parent = track})

    local fill = New("Frame", {
        BorderSizePixel = 0,
        Size = UDim2.new(0, 0, 1, 0),
        Parent = track,
    })
    win:_track(fill, "BackgroundColor3", "Accent")
    New("UICorner", {CornerRadius = UDim.new(0, 2), Parent = fill})

    local knob = New("Frame", {
        BorderSizePixel = 0,
        Size = UDim2.fromOffset(10, 10),
        Parent = track,
    })
    win:_track(knob, "BackgroundColor3", "Muted")
    New("UICorner", {CornerRadius = UDim.new(0, 2), Parent = knob})

    local function setVisual(v, tweenIt)
        local t = (v - minv) / (maxv - minv)
        t = Clamp01(t)

        local fillSize = UDim2.new(t, 0, 1, 0)
        local knobPos  = UDim2.new(t, -5, 0.5, -5)

        if tweenIt then
            PlayTween(fill, {Size = fillSize}, 0.12)
            PlayTween(knob, {Position = knobPos}, 0.12)
        else
            fill.Size     = fillSize
            knob.Position = knobPos
        end

        local text = c.Format and c.Format(v) or tostring(v)
        valueText.Text = text
    end

    local function syncProfile()
        local key = getProfileKey()
        local v   = valuesByProfile[key]
        if v == nil then
            v = defaultValue
            valuesByProfile[key] = v
        end
        value = v
        setVisual(v, false)
    end

    local function setValue(v, fromUser)
        v = RoundStep(math.clamp(v, minv, maxv), minv, step)
        value = v
        valuesByProfile[getProfileKey()] = v
        setVisual(v, true)
        if fromUser and c.Callback then
            task.spawn(c.Callback, v)
        end
    end

    syncProfile()

    local dragging
    local activeInput

    local function valueFromInput(input)
        local x = input.Position.X - track.AbsolutePosition.X
        local ratio = Clamp01(x / math.max(track.AbsoluteSize.X, 1))
        return minv + ratio * (maxv - minv)
    end

    local function begin(input)
        dragging    = true
        activeInput = input
        PlayTween(knob, {BackgroundColor3 = win.Theme.Accent}, 0.1)
        setValue(valueFromInput(input), true)

        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging    = false
                activeInput = nil
                PlayTween(knob, {BackgroundColor3 = win.Theme.Muted}, 0.1)
            end
        end)
    end

    track.InputBegan:Connect(function(input)
        if IsMouse(input.UserInputType) or IsTouch(input.UserInputType) then
            begin(input)
        end
    end)

    track.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement
            or input.UserInputType == Enum.UserInputType.Touch then
            activeInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and input == activeInput then
            setValue(valueFromInput(input), true)
        end
    end)

    local obj = {}
    function obj:Set(v)
        v = RoundStep(math.clamp(v, minv, maxv), minv, step)
        value = v
        valuesByProfile[getProfileKey()] = v
        setVisual(v, false)
    end
    function obj:Get()
        return value
    end
    function obj:_syncProfile()
        syncProfile()
    end
    obj._profileValues = valuesByProfile

    table.insert(self._controls, obj)
    return obj
end

function Section:CreateToggle(cfg)
    local win   = self.Window
    local inner = self.Inner
    local tab   = self.Tab
    local c     = cfg or {}

    local function getProfileKey()
        if tab and tab._activeTopTab then
            return tab._activeTopTab
        end
        return "__default"
    end

    local stateByProfile = {}
    local defaultState   = c.Default and true or false
    stateByProfile[getProfileKey()] = defaultState
    local state = defaultState

    local small = c.Small or false

    local row = New("TextButton", {
        AutoButtonColor = false,
        BackgroundTransparency = 1,
        Text = "",
        Size = UDim2.new(1, 0, 0, 24),
        Parent = inner,
    })

    local label = New("TextLabel", {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -70, 1, 0),
        Font = Enum.Font.Gotham,
        Text = c.Name or "Toggle",
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = row,
    })
    win:_track(label, "TextColor3", "Text")

    local obj = {}

    if small then
        local box = New("Frame", {
            BorderSizePixel = 0,
            Size = UDim2.fromOffset(16, 16),
            Position = UDim2.new(1, -24, 0.5, -8),
            Parent = row,
        })
        win:_track(box, "BackgroundColor3", "Field")
        New("UICorner", {CornerRadius = UDim.new(0, 3), Parent = box})
        local st = New("UIStroke", {Thickness = 1, Transparency = 0.55, Parent = box})
        win:_track(st, "Color", "Stroke")

        local fill = New("Frame", {
            BorderSizePixel = 0,
            Size = UDim2.new(1, -4, 1, -4),
            Position = UDim2.fromOffset(2, 2),
            Parent = box,
        })
        New("UICorner", {CornerRadius = UDim.new(0, 2), Parent = fill})

        local function render(animated)
            local col = state and win.Theme.Accent or win.Theme.Track
            if animated then
                PlayTween(fill, {BackgroundColor3 = col}, 0.12)
            else
                fill.BackgroundColor3 = col
            end
        end

        local function syncProfile()
            local key = getProfileKey()
            local s   = stateByProfile[key]
            if s == nil then
                s = defaultState
                stateByProfile[key] = s
            end
            state = s
            render(false)
        end

        syncProfile()

        row.MouseButton1Click:Connect(function()
            state = not state
            stateByProfile[getProfileKey()] = state
            render(true)
            if c.Callback then
                task.spawn(c.Callback, state)
            end
        end)

        function obj:Set(v)
            state = v and true or false
            stateByProfile[getProfileKey()] = state
            render(false)
        end
        function obj:Get()
            return state
        end
        function obj:_syncProfile()
            syncProfile()
        end
        obj._profileValues = stateByProfile
    else
        local sw = New("Frame", {
            BorderSizePixel = 0,
            Size = UDim2.fromOffset(28, 18),
            Position = UDim2.new(1, -36, 0.5, -9),
            Parent = row,
        })
        win:_track(sw, "BackgroundColor3", "Field")
        New("UICorner", {CornerRadius = UDim.new(0, 10), Parent = sw})
        local st = New("UIStroke", {Thickness = 1, Transparency = 0.55, Parent = sw})
        win:_track(st, "Color", "Stroke")

        local fill = New("Frame", {
            BorderSizePixel = 0,
            Size = UDim2.new(1, -4, 1, -4),
            Position = UDim2.fromOffset(2, 2),
            Parent = sw,
        })
        New("UICorner", {CornerRadius = UDim.new(0, 10), Parent = fill})

        local knob = New("Frame", {
            BorderSizePixel = 0,
            Size = UDim2.fromOffset(12, 12),
            Parent = sw,
        })
        New("UICorner", {CornerRadius = UDim.new(1, 0), Parent = knob})

        local function render(animated)
            local onCol  = win.Theme.Accent
            local offCol = win.Theme.Track
            local posOn  = UDim2.fromOffset(13, 3)
            local posOff = UDim2.fromOffset(3, 3)
            local col    = state and onCol or offCol

            if animated then
                PlayTween(fill, {BackgroundColor3 = col}, 0.12)
                PlayTween(knob, {Position = state and posOn or posOff, BackgroundColor3 = Color3.new(1,1,1)}, 0.12)
            else
                fill.BackgroundColor3 = col
                knob.Position         = state and posOn or posOff
                knob.BackgroundColor3 = Color3.new(1,1,1)
            end
        end

        local function syncProfile()
            local key = getProfileKey()
            local s   = stateByProfile[key]
            if s == nil then
                s = defaultState
                stateByProfile[key] = s
            end
            state = s
            render(false)
        end

        syncProfile()

        row.MouseButton1Click:Connect(function()
            state = not state
            stateByProfile[getProfileKey()] = state
            render(true)
            if c.Callback then
                task.spawn(c.Callback, state)
            end
        end)

        function obj:Set(v)
            state = v and true or false
            stateByProfile[getProfileKey()] = state
            render(false)
        end
        function obj:Get()
            return state
        end
        function obj:_syncProfile()
            syncProfile()
        end
        obj._profileValues = stateByProfile
    end

    table.insert(self._controls, obj)
    return obj
end

function Section:CreateButton(cfg)
    local win   = self.Window
    local inner = self.Inner
    local c     = cfg or {}

    local btn = New("TextButton", {
        AutoButtonColor = false,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 24),
        Font = Enum.Font.GothamBold,
        Text = c.Name or "Button",
        TextSize = 11,
        Parent = inner,
    })
    win:_track(btn, "BackgroundColor3", "Field")
    win:_track(btn, "TextColor3", "Text")
    New("UICorner", {CornerRadius = UDim.new(0, 3), Parent = btn})
    local st = New("UIStroke", {Thickness = 1, Transparency = 0.55, Parent = btn})
    win:_track(st, "Color", "Stroke")

    btn.MouseButton1Click:Connect(function()
        PlayTween(btn, {BackgroundColor3 = win.Theme.Track}, 0.08)
        if c.Callback then
            task.spawn(c.Callback)
        end
        task.delay(0.08, function()
            if btn.Parent then
                PlayTween(btn, {BackgroundColor3 = win.Theme.Field}, 0.12)
            end
        end)
    end)

    return btn
end

function Section:CreateTextbox(cfg)
    local win   = self.Window
    local inner = self.Inner
    local tab   = self.Tab
    local c     = cfg or {}

    local function getProfileKey()
        if tab and tab._activeTopTab then
            return tab._activeTopTab
        end
        return "__default"
    end

    local valuesByProfile = {}
    local defaultText     = c.Default or ""
    valuesByProfile[getProfileKey()] = defaultText

    local box = New("TextBox", {
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 24),
        Font = Enum.Font.Gotham,
        Text = defaultText,
        PlaceholderText = c.Placeholder or "Enter text here",
        TextSize = 11,
        ClearTextOnFocus = false,
        Parent = inner,
    })
    win:_track(box, "BackgroundColor3", "Field")
    win:_track(box, "TextColor3", "Text")
    box.PlaceholderColor3 = win.Theme.Muted
    New("UICorner", {CornerRadius = UDim.new(0, 3), Parent = box})
    local st = New("UIStroke", {Thickness = 1, Transparency = 0.55, Parent = box})
    win:_track(st, "Color", "Stroke")

    local function syncProfile()
        local key = getProfileKey()
        local t   = valuesByProfile[key]
        if t == nil then
            t = defaultText
            valuesByProfile[key] = t
        end
        box.Text = t
    end

    syncProfile()

    box.FocusLost:Connect(function(enterPressed)
        valuesByProfile[getProfileKey()] = box.Text
        if c.Callback then
            task.spawn(c.Callback, box.Text, enterPressed)
        end
    end)

    local obj = {}
    function obj:SetText(t)
        t = t or ""
        valuesByProfile[getProfileKey()] = t
        box.Text = t
    end
    function obj:GetText()
        return box.Text
    end
    function obj:_syncProfile()
        syncProfile()
    end
    obj._profileValues = valuesByProfile

    table.insert(self._controls, obj)
    return obj
end

function Section:CreateDropdown(cfg)
    local win   = self.Window
    local inner = self.Inner
    local tab   = self.Tab
    local c     = cfg or {}

    local function getProfileKey()
        if tab and tab._activeTopTab then
            return tab._activeTopTab
        end
        return "__default"
    end

    local options           = c.Options or {}
    local defaultSelection  = c.Default or options[1] or "None"
    local selectedByProfile = {}
    selectedByProfile[getProfileKey()] = defaultSelection

    local current   = defaultSelection
    local open      = false
    local maxHeight = c.MaxHeight -- optional

    local wrap = New("Frame", {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 30),
        AutomaticSize = Enum.AutomaticSize.Y,
        Parent = inner,
    })

    local head = New("TextButton", {
        AutoButtonColor = false,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 24),
        Text = "",
        Parent = wrap,
    })
    win:_track(head, "BackgroundColor3", "Field")
    New("UICorner", {CornerRadius = UDim.new(0, 3), Parent = head})
    local st = New("UIStroke", {Thickness = 1, Transparency = 0.55, Parent = head})
    win:_track(st, "Color", "Stroke")

    local nameLbl = New("TextLabel", {
        BackgroundTransparency = 1,
        Position = UDim2.fromOffset(10, 0),
        Size = UDim2.new(0.6, -10, 1, 0),
        Font = Enum.Font.Gotham,
        Text = c.Name or "Dropdown",
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = head,
    })
    win:_track(nameLbl, "TextColor3", "DimText")

    local valLbl = New("TextLabel", {
        BackgroundTransparency = 1,
        Position = UDim2.new(0.6, 0, 0, 0),
        Size = UDim2.new(0.4, -26, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = tostring(current),
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Right,
        Parent = head,
    })
    win:_track(valLbl, "TextColor3", "Text")

    local arrow = New("TextLabel", {
        BackgroundTransparency = 1,
        Position = UDim2.new(1, -22, 0, 0),
        Size = UDim2.fromOffset(20, 24),
        Font = Enum.Font.GothamBold,
        Text = "▾",
        TextSize = 14,
        Parent = head,
    })
    win:_track(arrow, "TextColor3", "Muted")

    local listWrap = New("Frame", {
        BackgroundTransparency = 1,
        Position = UDim2.fromOffset(0, 28),
        Size = UDim2.new(1, 0, 0, 0),
        ClipsDescendants = true,
        Parent = wrap,
    })

    local listBg = New("Frame", {
        BorderSizePixel        = 0,
        Size                   = UDim2.new(1, 0, 0, 0),
        BackgroundTransparency = 0,
        Parent                 = listWrap,
    })
    win:_track(listBg, "BackgroundColor3", "Field")
    New("UICorner", {CornerRadius = UDim.new(0, 3), Parent = listBg})
    local st2 = New("UIStroke", {Thickness = 1, Transparency = 0.55, Parent = listBg})
    win:_track(st2, "Color", "Stroke")

    local list = New("UIListLayout", {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding   = UDim.new(0, 6),
        Parent    = listBg,
    })
    New("UIPadding", {
        PaddingTop    = UDim.new(0, 6),
        PaddingLeft   = UDim.new(0, 10),
        PaddingRight  = UDim.new(0, 10),
        PaddingBottom = UDim.new(0, 6),
        Parent        = listBg,
    })

    local function applySelectionForCurrentProfile(sel, callCallback)
        current = sel
        selectedByProfile[getProfileKey()] = sel
        valLbl.Text = tostring(current)
        if callCallback and c.Callback then
            task.spawn(c.Callback, current)
        end
    end

    local setOpen -- forward

    local function rebuild()
        for _, child in ipairs(listBg:GetChildren()) do
            if child:IsA("TextButton") then
                child:Destroy()
            end
        end

        for _, opt in ipairs(options) do
            local b = New("TextButton", {
                AutoButtonColor = false,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 0, 20),
                Font = Enum.Font.Gotham,
                Text = tostring(opt),
                TextSize = 11,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = listBg,
            })
            b.TextColor3 = (opt == current) and win.Theme.Accent or win.Theme.Text

            b.MouseButton1Click:Connect(function()
                applySelectionForCurrentProfile(opt, true)
                rebuild()
                setOpen(false)
            end)
        end

        task.defer(function()
            local contentHeight = list.AbsoluteContentSize.Y + 12
            listBg.Size = UDim2.new(1, 0, 0, contentHeight)
            if open then
                local h = contentHeight
                if maxHeight then
                    h = math.min(h, maxHeight)
                end
                listWrap.Size = UDim2.new(1, 0, 0, h)
            end
        end)
    end

    local function syncProfile()
        local key = getProfileKey()
        local sel = selectedByProfile[key]
        if sel == nil then
            sel = defaultSelection
            selectedByProfile[key] = sel
        end
        current = sel
        valLbl.Text = tostring(current)
        rebuild()
    end

    syncProfile()

    setOpen = function(state)
        open = state
        if open then
            task.defer(function()
                local contentHeight = list.AbsoluteContentSize.Y + 12
                local h = contentHeight
                if maxHeight then
                    h = math.min(h, maxHeight)
                end
                PlayTween(listWrap, {Size = UDim2.new(1, 0, 0, h)}, 0.14)
                PlayTween(listBg,   {Size = UDim2.new(1, 0, 0, contentHeight)}, 0.14)
            end)
            arrow.Text = "▴"
        else
            PlayTween(listWrap, {Size = UDim2.new(1, 0, 0, 0)}, 0.14)
            PlayTween(listBg,   {Size = UDim2.new(1, 0, 0, 0)}, 0.14)
            arrow.Text = "▾"
        end
    end

    head.MouseButton1Click:Connect(function()
        setOpen(not open)
    end)

    local obj = {}
    function obj:SetOptions(opts)
        options = opts or {}
        if not table.find(options, current) then
            current = options[1] or "None"
            selectedByProfile[getProfileKey()] = current
            valLbl.Text = tostring(current)
        end
        rebuild()
        setOpen(false)
    end
    function obj:Set(v)
        if table.find(options, v) then
            applySelectionForCurrentProfile(v, false)
            rebuild()
        end
    end
    function obj:Get()
        return current
    end
    function obj:_syncProfile()
        syncProfile()
    end
    obj._profileValues = selectedByProfile

    table.insert(self._controls, obj)
    return obj
end

--------------------------------------------------------------------- -- CreateWindow
--------------------------------------------------------------------- 

function Vanith:CreateWindow(opts)
    opts = opts or {}

    local theme = {}
    for k, v in pairs(DEFAULT_THEME) do
        theme[k] = v
    end
    for k, v in pairs(opts.Theme or {}) do
        theme[k] = v
    end

    local parent
    do
        local ok, cg = pcall(function()
            if gethui then
                return gethui()
            end
            return game:GetService("CoreGui")
        end)
        if ok and cg then
            parent = cg
        else
            local lp = Players.LocalPlayer
            parent = lp and lp:FindFirstChildOfClass("PlayerGui") or nil
        end
    end

    local sizeOpt = opts.StartSize or opts.Size
    local initialSize
    if typeof(sizeOpt) == "Vector2" then
        initialSize = UDim2.fromOffset(sizeOpt.X, sizeOpt.Y)
    elseif typeof(sizeOpt) == "UDim2" then
        initialSize = sizeOpt
    else
        initialSize = UDim2.fromOffset(649, 417)
    end

    local baseWidth   = initialSize.X.Offset > 0 and initialSize.X.Offset or 649
    local baseHeight  = initialSize.Y.Offset > 0 and initialSize.Y.Offset or 417
    local minSizeVec  = Vector2.new(baseWidth, baseHeight)

    local isMobile = UserInputService.TouchEnabled
        and not UserInputService.KeyboardEnabled
        and not UserInputService.MouseEnabled

    local self = setmetatable({
        Theme          = theme,
        _themeBindings = {},
        Tabs           = {},
        TopTabs        = {},
        MinSize        = minSizeVec,
        IsMobile       = isMobile,
    }, Window)

    local gui = New("ScreenGui", {
        Name = opts.Name or "VanithUI",
        ResetOnSpawn = false,
        IgnoreGuiInset = true,
        Parent = parent,
    })
    self.Gui = gui

    local main = New("Frame", {
        Size = initialSize,
        Position = opts.Position or UDim2.fromScale(0.5, 0.5),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BorderSizePixel = 0,
        Parent = gui,
    })
    self.Main = main
    self:_track(main, "BackgroundColor3", "BG0")
    New("UICorner", {CornerRadius = UDim.new(0, 10), Parent = main})
    local ms = New("UIStroke", {Thickness = 1, Transparency = 0.2, Parent = main})
    self:_track(ms, "Color", "Stroke")

    local glass = New("Frame", {
        BackgroundColor3 = Color3.new(1, 1, 1),
        BackgroundTransparency = 0.97,
        BorderSizePixel = 0,
        Size = UDim2.fromScale(1, 1),
        Parent = main,
        ZIndex = 0,
    })
    New("UICorner", {CornerRadius = UDim.new(0, 10), Parent = glass})

    local top = New("Frame", {
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 54),
        Parent = main,
        ZIndex = 2,
    })
    self.TopBar = top
    self:_track(top, "BackgroundColor3", "BG2")
    New("UICorner", {CornerRadius = UDim.new(0, 10), Parent = top})

    local brand = New("Frame", {
        BorderSizePixel = 0,
        Position = UDim2.fromOffset(12, 10),
        Size = UDim2.fromOffset(140, 34),
        Parent = top,
        ZIndex = 3,
    })
    self:_track(brand, "BackgroundColor3", "BG2")
    New("UICorner", {CornerRadius = UDim.new(0, 8), Parent = brand})
    local bStroke = New("UIStroke", {Thickness = 1, Transparency = 0.55, Parent = brand})
    self:_track(bStroke, "Color", "Stroke")

    local windowTitle = (type(opts.Title) == "string" and opts.Title) or "Vanith"

    local brandLabel = New("TextLabel", {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -8, 1, 0),
        Position = UDim2.new(0, 4, 0, 0),
        Font = Enum.Font.GothamBold,
        Text = windowTitle,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Center,
        Parent = brand,
        ZIndex = 4,
    })
    self:_track(brandLabel, "TextColor3", "Accent")

    local function fitTitle()
        local maxSize = 14
        local minSize = 10
        for size = maxSize, minSize, -1 do
            brandLabel.TextSize = size
            if brand.AbsoluteSize.X > 0 then
                if brandLabel.TextBounds.X <= (brand.AbsoluteSize.X - 8) then
                    break
                end
            end
        end
    end

    brand:GetPropertyChangedSignal("AbsoluteSize"):Connect(fitTitle)
    brandLabel:GetPropertyChangedSignal("Text"):Connect(fitTitle)
    fitTitle()

    -- Tab-Strip mit dynamischem Layout (zentriert, solange kein Scroll nötig)
    local strip = New("Frame", {
        BorderSizePixel = 0,
        Position = UDim2.fromOffset(160, 10),
        Size = UDim2.new(1, -264, 0, 34),
        Parent = top,
        ZIndex = 2,
    })
    self:_track(strip, "BackgroundColor3", "BG2")
    New("UICorner", {CornerRadius = UDim.new(0, 8), Parent = strip})
    local sStroke = New("UIStroke", {Thickness = 1, Transparency = 0.5, Parent = strip})
    self:_track(sStroke, "Color", "Stroke")

    local tabsHolder = New("ScrollingFrame", {
        BackgroundTransparency = 1,
        Position = UDim2.fromOffset(8, 0),
        Size = UDim2.new(1, -16, 1, 0),
        Parent = strip,
        ZIndex = 3,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ScrollBarThickness = 0, -- unsichtbar wenn nicht gebraucht
        ScrollBarImageTransparency = 0.3,
        ScrollBarImageColor3 = theme.Accent,
        ScrollingDirection = Enum.ScrollingDirection.X,
        ScrollingEnabled = false,
    })
    self.TopTabsHolder = tabsHolder

    local topLayout = New("UIListLayout", {
        FillDirection = Enum.FillDirection.Horizontal,
        SortOrder     = Enum.SortOrder.LayoutOrder,
        Padding       = UDim.new(0, 26),
        Parent        = tabsHolder,
    })
    topLayout.VerticalAlignment   = Enum.VerticalAlignment.Center
    topLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

    local function updateTopTabsLayout()
        local contentW = topLayout.AbsoluteContentSize.X
        local viewW    = tabsHolder.AbsoluteSize.X

        if contentW <= viewW then
            -- alles passt rein -> Tabs mittig, kein Scroll
            topLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
            tabsHolder.CanvasSize         = UDim2.new(0, viewW, 0, 0)
            tabsHolder.ScrollingEnabled   = false
            tabsHolder.ScrollBarThickness = 0
            tabsHolder.CanvasPosition     = Vector2.new(0, 0)
        else
            -- zu viele Tabs -> links ausrichten + Scroll aktivieren
            topLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
            tabsHolder.CanvasSize         = UDim2.new(0, contentW + 16, 0, 0)
            tabsHolder.ScrollingEnabled   = true
            tabsHolder.ScrollBarThickness = 2
        end
    end

    topLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateTopTabsLayout)
    tabsHolder:GetPropertyChangedSignal("AbsoluteSize"):Connect(updateTopTabsLayout)
    task.defer(updateTopTabsLayout)

    -- Minimize / Close Box
    local controlBox = New("Frame", {
        BorderSizePixel = 0,
        Position = UDim2.new(1, -96, 0, 10),
        Size = UDim2.fromOffset(84, 34),
        Parent = top,
        ZIndex = 3,
    })
    self:_track(controlBox, "BackgroundColor3", "BG2")
    New("UICorner", {CornerRadius = UDim.new(0, 8), Parent = controlBox})
    local cbStroke = New("UIStroke", {Thickness = 1, Transparency = 0.55, Parent = controlBox})
    self:_track(cbStroke, "Color", "Stroke")

    local minimizeBtn = New("TextButton", {
        AutoButtonColor = false,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.5, 0, 1, 0),
        Position = UDim2.new(0, 0, 0, 0),
        Font = Enum.Font.GothamBold,
        Text = "-",
        TextSize = 14,
        Parent = controlBox,
        ZIndex = 4,
    })
    self:_track(minimizeBtn, "TextColor3", "Accent")

    local closeBtn = New("TextButton", {
        AutoButtonColor = false,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.5, 0, 1, 0),
        Position = UDim2.new(0.5, 0, 0, 0),
        Font = Enum.Font.GothamBold,
        Text = "X",
        TextSize = 14,
        Parent = controlBox,
        ZIndex = 4,
    })
    self:_track(closeBtn, "TextColor3", "Accent")

    minimizeBtn.MouseButton1Click:Connect(function()
        PlayTween(minimizeBtn, {TextColor3 = self.Theme.Muted}, 0.08)
        task.delay(0.08, function()
            if minimizeBtn.Parent then
                minimizeBtn.TextColor3 = self.Theme.Accent
            end
        end)
    end)

    closeBtn.MouseButton1Click:Connect(function()
        if self.Gui then
            self.Gui:Destroy()
        end
    end)

    local sidebar = New("Frame", {
        BorderSizePixel = 0,
        Position = UDim2.fromOffset(12, 66),
        Size = UDim2.new(0, 120, 1, -78),
        Parent = main,
        ZIndex = 1,
    })
    self.Sidebar = sidebar
    self:_track(sidebar, "BackgroundColor3", "BG2")
    New("UICorner", {CornerRadius = UDim.new(0, 8), Parent = sidebar})
    local sbStroke = New("UIStroke", {Thickness = 1, Transparency = 0.25, Parent = sidebar})
    self:_track(sbStroke, "Color", "Stroke")

    local sideList = New("Frame", {
        BackgroundTransparency = 1,
        Position = UDim2.fromOffset(10, 14),
        Size = UDim2.new(1, -20, 1, -24),
        Parent = sidebar,
    })
    self.SideList = sideList
    local sideLayout = New("UIListLayout", {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding   = UDim.new(0, 6),
        Parent    = sideList,
    })
    sideLayout.VerticalAlignment = Enum.VerticalAlignment.Top

    local pages = New("Frame", {
        BackgroundTransparency = 1,
        Position = UDim2.fromOffset(146, 66),
        Size = UDim2.new(1, -158, 1, -78),
        Parent = main,
    })
    self.Pages = pages

    local resize = New("Frame", {
        BackgroundTransparency = 1,
        Size = UDim2.fromOffset(16, 16),
        Position = UDim2.new(1, -18, 1, -18),
        Parent = main,
        ZIndex = 5,
    })
    local resizeLbl = New("TextLabel", {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = "↘",
        TextSize = 14,
        Parent = resize,
    })
    self:_track(resizeLbl, "TextColor3", "Accent")

    self:_enableResize(resize, main)

    if opts.Draggable ~= false then
        self:_enableDrag(top, main)
    end

    local scale = New("UIScale", {Parent = main})
    local cam   = workspace.CurrentCamera

    if isMobile then
        scale.Scale = 0.70
    elseif cam then
        local vp = cam.ViewportSize
        if vp.X < 900 then
            scale.Scale = math.clamp(vp.X / 900, 0.75, 1)
        else
            scale.Scale = 1
        end
    else
        scale.Scale = 1
    end

    return self
end

Vanith.Createwindow = Vanith.CreateWindow

return Vanith
